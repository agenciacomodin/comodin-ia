"use strict";exports.id=4611,exports.ids=[4611],exports.modules={4611:(e,t,a)=>{a.a(e,async(e,r)=>{try{a.d(t,{O:()=>u});var o=a(92115),n=a(78982),i=a(53524),s=a(83178),c=a(84770),d=a(27769),l=e([o]);o=(l.then?(await l)():l)[0];class u{static async processAIRequest(e){let t=Date.now();try{let a=this.generatePromptHash(e.prompt),r=await this.getCachedResponse(e.organizationId,a);if(r){console.log("\uD83D\uDCA1 Cach\xe9 hit - devolviendo respuesta almacenada");let a=await this.processCacheUsage(e,r);return{success:!0,response:r.response,transactionId:a.transactionId,cost:a.cost,usage:{inputTokens:0,outputTokens:0,totalTokens:0,processingTime:Date.now()-t},provider:{name:`${r.originalProvider} (Cach\xe9)`,model:r.originalModel}}}if(console.log("\uD83D\uDD04 Cach\xe9 miss - procesando solicitud normal"),!await this.checkSufficientBalance(e.organizationId,e.prompt))return{success:!1,error:"Saldo Insuficiente: No hay suficiente saldo en la billetera para procesar esta solicitud de IA"};let s=await this.enrichWithEcommerceData(e),c=await this.getProviderForRequest(s);if(!c)return{success:!1,error:"No hay proveedores de IA disponibles actualmente"};let d=await (0,n.Dx)(c.id),l=await this.callExternalProvider(c,d,s);if(!l.success)return{success:!1,error:`Error del proveedor ${c.name}: ${l.error}`};let u=Date.now()-t,p=await this.calculateCosts(c,l.usage.inputTokens,l.usage.outputTokens),m={organizationId:e.organizationId,userId:e.userId,userName:e.userName,usageType:e.usageType||i.AIUsageType.CHAT_RESPONSE,providerName:c.name,modelUsed:l.modelUsed,providerCost:p.providerCost,inputTokens:l.usage.inputTokens,outputTokens:l.usage.outputTokens,processingTime:u,description:`AI Request via Broker: ${e.usageType||"CHAT_RESPONSE"}`,metadata:{...e.metadata,prompt_length:e.prompt.length,provider_id:c.id,model_used:l.modelUsed,temperature:e.temperature,max_tokens:e.maxTokens}},h=await o.s.processAIUsage(m);if(l.response)try{await this.saveToCacheIntelligent(e.organizationId,a,l.response,c.name,l.modelUsed,p.providerCost),console.log("\uD83D\uDCBE Respuesta guardada en cach\xe9 inteligente")}catch(e){console.warn("âš ï¸ Error guardando en cach\xe9 (no cr\xedtico):",e)}return await this.updateProviderLastUsed(c.id),{success:!0,response:l.response||"",transactionId:h.id,cost:{providerCost:p.providerCost,clientCost:p.clientCost,margin:.3},usage:{inputTokens:l.usage.inputTokens,outputTokens:l.usage.outputTokens,totalTokens:l.usage.inputTokens+l.usage.outputTokens,processingTime:u},provider:{name:c.displayName,model:l.modelUsed}}}catch(e){return console.error("Error in AI Broker Service:",e),{success:!1,error:e.message||"Error interno del servidor"}}}static async checkSufficientBalance(e,t){try{let a=Math.ceil(t.length/4);return await o.s.hasSufficientBalance(e,2e-5*a)}catch(e){return console.error("Error checking balance:",e),!1}}static async getProviderForRequest(e){try{let e=await (0,n.hI)();if(0===e.length)return null;let t=e.find(e=>e.isDefault)||e[0];return{id:t.id,name:t.name,displayName:t.displayName,apiUrl:t.apiUrl,defaultModel:t.defaultModel||"gpt-3.5-turbo",isDefault:t.isDefault}}catch(e){return console.error("Error getting provider:",e),null}}static async callExternalProvider(e,t,a){try{if("openai"===e.name.toLowerCase())return await this.callOpenAI(e,t,a);if("gemini"===e.name.toLowerCase()||"google"===e.name.toLowerCase())return await this.callGemini(e,t,a);return await this.callGenericProvider(e,t,a)}catch(t){return console.error(`Error calling ${e.name}:`,t),{success:!1,error:t.message||"Error desconocido del proveedor",usage:{inputTokens:0,outputTokens:0},modelUsed:e.defaultModel}}}static async callOpenAI(e,t,a){let r=await fetch(`${e.apiUrl}/chat/completions`,{method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify({model:a.model||e.defaultModel,messages:[{role:"user",content:a.prompt}],max_tokens:a.maxTokens||1e3,temperature:a.temperature||.7})});if(!r.ok){let e=await r.text();throw Error(`OpenAI API Error: ${r.status} - ${e}`)}let o=await r.json();return{success:!0,response:o.choices[0]?.message?.content||"Sin respuesta",usage:{inputTokens:o.usage?.prompt_tokens||0,outputTokens:o.usage?.completion_tokens||0},modelUsed:o.model||a.model||e.defaultModel}}static async callGemini(e,t,a){let r=a.model||e.defaultModel||"gemini-pro",o=await fetch(`${e.apiUrl}/v1/models/${r}:generateContent?key=${t}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contents:[{parts:[{text:a.prompt}]}],generationConfig:{temperature:a.temperature||.7,maxOutputTokens:a.maxTokens||1e3}})});if(!o.ok){let e=await o.text();throw Error(`Gemini API Error: ${o.status} - ${e}`)}let n=await o.json();return{success:!0,response:n.candidates?.[0]?.content?.parts?.[0]?.text||"Sin respuesta",usage:{inputTokens:n.usageMetadata?.promptTokenCount||Math.ceil(a.prompt.length/4),outputTokens:n.usageMetadata?.candidatesTokenCount||50},modelUsed:r}}static async callGenericProvider(e,t,a){throw Error(`Proveedor ${e.name} no implementado a\xfan`)}static async calculateCosts(e,t,a){try{let r=await s.db.aIProvider.findUnique({where:{id:e.id},select:{inputPricePerToken:!0,outputPricePerToken:!0}}),o=0;o=r?.inputPricePerToken&&r?.outputPricePerToken?t*r.inputPricePerToken.toNumber()+a*r.outputPricePerToken.toNumber():"openai"===e.name.toLowerCase()?15e-7*t+2e-6*a:"gemini"===e.name.toLowerCase()?125e-8*t+375e-8*a:(t+a)*2e-6;let n=1.3*o;return{providerCost:o,clientCost:n}}catch(r){console.error("Error calculating costs:",r);let e=(t+a)*2e-6;return{providerCost:e,clientCost:1.3*e}}}static async updateProviderLastUsed(e){try{await s.db.aIProvider.update({where:{id:e},data:{lastUsedAt:new Date}})}catch(e){console.error("Error updating provider last used:",e)}}static async getBrokerStats(){try{let e=await s.db.aITransaction.findMany({where:{createdAt:{gte:new Date(new Date().setDate(new Date().getDate()-30))}},include:{provider:!0}}),t=e.length,a=e.reduce((e,t)=>e+t.clientCost.toNumber(),0),r=e.length>0?e.reduce((e,t)=>e+(t.processingTime||0),0)/e.length:0,o=e.reduce((e,t)=>{let a=t.provider?.displayName||t.providerName;return e[a]=(e[a]||0)+1,e},{}),n=Object.entries(o).map(([e,t])=>({name:e,usage:t})).sort((e,t)=>t.usage-e.usage).slice(0,5);return{totalRequests:t,totalCost:a,averageResponseTime:r,topProviders:n}}catch(e){return console.error("Error getting broker stats:",e),{totalRequests:0,totalCost:0,averageResponseTime:0,topProviders:[]}}}static generatePromptHash(e){let t=e.toLowerCase().trim().replace(/\s+/g," ").replace(/[^\w\s]/g,"");return(0,c.createHash)("md5").update(t).digest("hex")}static async getCachedResponse(e,t){try{return await s.db.aICache.findFirst({where:{organizationId:e,promptHash:t,isActive:!0,OR:[{expiresAt:null},{expiresAt:{gt:new Date}}]},orderBy:{lastUsedAt:"desc"}})}catch(e){return console.error("Error buscando en cach\xe9:",e),null}}static async processCacheUsage(e,t){try{let a=t.originalCost.toNumber(),r=.1*a,n={organizationId:e.organizationId,userId:e.userId,userName:e.userName,usageType:e.usageType||i.AIUsageType.CHAT_RESPONSE,providerName:`Cache-${t.originalProvider}`,modelUsed:`${t.originalModel} (Cached)`,providerCost:r,inputTokens:0,outputTokens:0,processingTime:0,description:`AI Cache Hit: ${e.usageType||"CHAT_RESPONSE"}`,metadata:{...e.metadata,cacheHit:!0,originalCost:a,cacheSavings:a-r,cacheId:t.id}},c=await o.s.processAIUsage(n);return await s.db.aICache.update({where:{id:t.id},data:{hitCount:{increment:1},lastUsedAt:new Date}}),{transactionId:c.id,cost:{providerCost:r,clientCost:1.3*r,margin:.3}}}catch(e){throw console.error("Error procesando uso de cach\xe9:",e),e}}static async saveToCacheIntelligent(e,t,a,r,o,n){try{let i=new Date;i.setDate(i.getDate()+30),await s.db.aICache.create({data:{organizationId:e,promptHash:t,response:a,originalProvider:r,originalModel:o,originalCost:n,hitCount:0,lastUsedAt:new Date,expiresAt:i,isActive:!0}})}catch(i){if(i instanceof Error&&i.message.includes("Unique constraint"))await s.db.aICache.update({where:{organizationId_promptHash:{organizationId:e,promptHash:t}},data:{response:a,originalProvider:r,originalModel:o,originalCost:n,lastUsedAt:new Date,updatedAt:new Date}});else throw i}}static async purgeAICache(e){try{let t=await s.db.aICache.deleteMany({where:e?{organizationId:e}:{}});return console.log(`ðŸ—‘ï¸ Cach\xe9 de IA purgado: ${t.count} entradas eliminadas`),{deletedCount:t.count}}catch(e){throw console.error("Error purgando cach\xe9 de IA:",e),Error("Failed to purge AI cache")}}static async getCacheStats(e){try{let t=await s.db.aICache.findMany({where:e?{organizationId:e}:{},orderBy:{hitCount:"desc"}}),a=t.length,r=t.reduce((e,t)=>e+t.hitCount,0),o=t.reduce((e,t)=>{let a=t.originalCost.toNumber();return e+(a-.1*a)*t.hitCount},0),n=t.slice(0,10).map(e=>({promptHash:e.promptHash,hitCount:e.hitCount,response:e.response.substring(0,100)+"..."}));return{totalEntries:a,totalHits:r,averageHitRate:a>0?r/a:0,totalSavings:o,topCachedQueries:n}}catch(e){return console.error("Error obteniendo estad\xedsticas de cach\xe9:",e),{totalEntries:0,totalHits:0,averageHitRate:0,totalSavings:0,topCachedQueries:[]}}}static async enrichWithEcommerceData(e){try{let t=d.B.detectEcommerceIntent(e.prompt);if(!t.needsEcommerce)return e;console.log("\uD83D\uDED2 E-commerce intent detected:",t);let a=null,r="";try{a=await d.B.executeQuery(e.organizationId,{type:t.queryType,params:t.params}),r=this.formatEcommerceContext(t.queryType,a)}catch(e){console.log("âš ï¸ Error fetching e-commerce data:",e),r=`

[INFORMACI\xd3N DEL SISTEMA]
No se pudieron consultar los datos de la tienda en este momento. Error: ${e instanceof Error?e.message:"Error desconocido"}
Por favor, solicita al cliente que verifique la conexi\xf3n con su tienda o contacte al administrador.`}let o=this.createEnrichedPrompt(e.prompt,r,t.queryType);return{...e,prompt:o,metadata:{...e.metadata,hasEcommerceData:!0,ecommerceIntent:t,originalPrompt:e.prompt}}}catch(t){return console.error("Error enriching with e-commerce data:",t),e}}static formatEcommerceContext(e,t){if(!t||Array.isArray(t)&&0===t.length)return`

[DATOS DE LA TIENDA]
No se encontraron resultados para la consulta de ${e}.`;let a=`

[DATOS ACTUALES DE LA TIENDA]
`;switch(e){case"product":a+=`Productos encontrados:
`,t.forEach((e,t)=>{a+=`${t+1}. ${e.name}
   - Precio: $${e.price} ${e.currency}
   - Stock: ${e.stock||"No disponible"}
   - SKU: ${e.sku||"N/A"}
   - Estado: ${e.status}
`,e.description&&(a+=`   - Descripci\xf3n: ${e.description.substring(0,100)}...
`),a+=`
`});break;case"order":a+=`Pedidos encontrados:
`,t.forEach((e,t)=>{a+=`${t+1}. Pedido ${e.orderNumber}
   - Estado: ${e.status}
   - Total: $${e.total} ${e.currency}
   - Cliente: ${e.customerName||e.customerEmail}
   - Fecha: ${new Date(e.createdAt).toLocaleDateString("es-ES")}
`,e.items&&e.items.length>0&&(a+=`   - Productos: ${e.items.map(e=>`${e.productName} (${e.quantity})`).join(", ")}
`),a+=`
`});break;case"customer":a+=`Clientes encontrados:
`,t.forEach((e,t)=>{a+=`${t+1}. ${e.name||e.email}
   - Email: ${e.email}
   - Tel\xe9fono: ${e.phone||"N/A"}
   - Total pedidos: ${e.totalOrders||0}
   - Total gastado: $${e.totalSpent||0}
   - Cliente desde: ${new Date(e.createdAt).toLocaleDateString("es-ES")}

`});break;case"inventory":a+=`Informaci\xf3n de inventario:
`,Array.isArray(t)&&t.forEach((e,t)=>{a+=`${t+1}. ${e.name||e.sku}
   - Stock disponible: ${e.available||"N/A"}
   - Ubicaci\xf3n: ${e.location||"N/A"}

`});break;default:a+=`Datos: ${JSON.stringify(t,null,2)}
`}return a}static createEnrichedPrompt(e,t,a){return`[INSTRUCCIONES PARA EL ASISTENTE]
Eres un asistente inteligente de atenci\xf3n al cliente para un negocio con tienda en l\xednea. 

IMPORTANTE:
1. Usa \xdaNICAMENTE los datos actualizados de la tienda proporcionados abajo
2. Si los datos est\xe1n vac\xedos o no coinciden con la pregunta, explica amablemente que no encuentras esa informaci\xf3n
3. S\xe9 espec\xedfico con precios, stock, n\xfameros de pedido y estados
4. Siempre mant\xe9n un tono profesional y servicial
5. Si hay errores de conexi\xf3n con la tienda, explica la situaci\xf3n y sugiere contactar al administrador

CONTEXTO ACTUAL DE LA TIENDA:${t}

PREGUNTA DEL CLIENTE:
${e}

Por favor responde usando \xfanicamente la informaci\xf3n proporcionada arriba.`}}r()}catch(e){r(e)}})},78982:(e,t,a)=>{a.d(t,{GN:()=>m,f9:()=>g,qI:()=>y,s0:()=>h,hI:()=>I,Dx:()=>E,V6:()=>T,jB:()=>f,yH:()=>w});var r=a(83178),o=a(84770),n=a.n(o);let i="aes-256-gcm";function s(){let e=process.env.ENCRYPTION_SECRET||"default-secret-key-change-in-production";return n().scryptSync(e,"salt",32)}function c(e){try{let t=s(),a=n().randomBytes(16),r=n().createCipher(i,t);r.setAAD(Buffer.from("apikey","utf8"));let o=r.update(e,"utf8","hex");o+=r.final("hex");let c=r.getAuthTag();return a.toString("hex")+c.toString("hex")+o}catch(e){throw console.error("Error encrypting API key:",e),Error("Failed to encrypt API key")}}function d(e){try{let t=s();Buffer.from(e.slice(0,32),"hex");let a=Buffer.from(e.slice(32,64),"hex"),r=e.slice(64),o=n().createDecipher(i,t);o.setAAD(Buffer.from("apikey","utf8")),o.setAuthTag(a);let c=o.update(r,"hex","utf8");return c+=o.final("utf8")}catch(e){throw console.error("Error decrypting API key:",e),Error("Failed to decrypt API key")}}function l(e){if(!e||e.length<8)return"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢";let t=e.slice(0,4),a=e.slice(-4),r="â€¢".repeat(Math.min(e.length-8,20));return`${t}${r}${a}`}function u(e,t){if(!e||"string"!=typeof e)return!1;switch(t.toLowerCase()){case"openai":return e.startsWith("sk-")&&e.length>20;case"anthropic":case"claude":return e.startsWith("sk-ant-")||e.startsWith("sk-");case"google":case"gemini":return e.length>=20;case"cohere":return e.length>=40;default:return e.length>=10}}function p(e){if("SUPER_ADMIN"!==e)throw Error("Access denied: Only Super Admin can manage AI providers")}async function m(e,t,a,o){if(p(o),!u(e.apiKey,e.name))throw Error(`Invalid API key format for ${e.name}`);if(await r._.aIProvider.findUnique({where:{name:e.name}}))throw Error(`Provider with name "${e.name}" already exists`);let n=await r._.aIProvider.count(),i=c(e.apiKey);return{...await r._.aIProvider.create({data:{name:e.name,displayName:e.displayName,description:e.description,logoUrl:e.logoUrl,apiUrl:e.apiUrl,apiKeyName:e.apiKeyName||"API_KEY",encryptedApiKey:i,defaultModel:e.defaultModel,availableModels:e.availableModels?JSON.parse(JSON.stringify(e.availableModels)):null,inputPricePerToken:e.inputPricePerToken,outputPricePerToken:e.outputPricePerToken,currency:e.currency||"USD",maxTokensPerRequest:e.maxTokensPerRequest,rateLimitPerMinute:e.rateLimitPerMinute,metadata:e.metadata?JSON.parse(JSON.stringify(e.metadata)):null,isDefault:0===n,createdBy:t,createdByName:a}}),maskedApiKey:l(e.apiKey)}}async function h(e){return p(e),(await r._.aIProvider.findMany({orderBy:[{isDefault:"desc"},{isActive:"desc"},{name:"asc"}]})).map(e=>({...e,maskedApiKey:l(d(e.encryptedApiKey))}))}async function y(e,t){p(t);let a=await r._.aIProvider.findUnique({where:{id:e}});if(!a)throw Error("AI Provider not found");return{...a,maskedApiKey:l(d(a.encryptedApiKey))}}async function w(e,t,a,o,n){p(n);let i=await r._.aIProvider.findUnique({where:{id:e}});if(!i)throw Error("AI Provider not found");if(t.name&&t.name!==i.name&&await r._.aIProvider.findUnique({where:{name:t.name}}))throw Error(`Provider with name "${t.name}" already exists`);let s=i.encryptedApiKey;if(t.apiKey){if(!u(t.apiKey,t.name||i.name))throw Error(`Invalid API key format for ${t.name||i.name}`);s=c(t.apiKey)}let m=await r._.aIProvider.update({where:{id:e},data:{...t.name&&{name:t.name},...t.displayName&&{displayName:t.displayName},...void 0!==t.description&&{description:t.description},...void 0!==t.logoUrl&&{logoUrl:t.logoUrl},...t.apiUrl&&{apiUrl:t.apiUrl},...t.apiKeyName&&{apiKeyName:t.apiKeyName},...t.apiKey&&{encryptedApiKey:s},...void 0!==t.defaultModel&&{defaultModel:t.defaultModel},...t.availableModels&&{availableModels:JSON.parse(JSON.stringify(t.availableModels))},...void 0!==t.inputPricePerToken&&{inputPricePerToken:t.inputPricePerToken},...void 0!==t.outputPricePerToken&&{outputPricePerToken:t.outputPricePerToken},...t.currency&&{currency:t.currency},...void 0!==t.maxTokensPerRequest&&{maxTokensPerRequest:t.maxTokensPerRequest},...void 0!==t.rateLimitPerMinute&&{rateLimitPerMinute:t.rateLimitPerMinute},...t.metadata&&{metadata:JSON.parse(JSON.stringify(t.metadata))},updatedBy:a,updatedByName:o,updatedAt:new Date}});return{...m,maskedApiKey:l(t.apiKey||d(m.encryptedApiKey))}}async function g(e,t){p(t);let a=await r._.aIProvider.findUnique({where:{id:e},include:{_count:{select:{transactions:!0}}}});if(!a)throw Error("AI Provider not found");a._count.transactions>0?await r._.aIProvider.update({where:{id:e},data:{isActive:!1}}):await r._.aIProvider.delete({where:{id:e}})}async function f(e,t,a,o,n){p(n);let i=await r._.aIProvider.update({where:{id:e},data:{isActive:t,updatedBy:a,updatedByName:o,updatedAt:new Date}});return{...i,maskedApiKey:l(d(i.encryptedApiKey))}}async function T(e,t,a,o){p(o),await r._.$transaction(async r=>{await r.aIProvider.updateMany({where:{isDefault:!0},data:{isDefault:!1}}),await r.aIProvider.update({where:{id:e},data:{isDefault:!0,updatedBy:t,updatedByName:a,updatedAt:new Date}})})}async function E(e){let t=await r._.aIProvider.findUnique({where:{id:e,isActive:!0}});if(!t)throw Error("Active AI Provider not found");return d(t.encryptedApiKey)}async function I(){return await r._.aIProvider.findMany({where:{isActive:!0},select:{id:!0,name:!0,displayName:!0,apiUrl:!0,defaultModel:!0,isDefault:!0},orderBy:[{isDefault:"desc"},{name:"asc"}]})}},92115:(e,t,a)=>{a.a(e,async(e,r)=>{try{a.d(t,{s:()=>c});var o=a(53524),n=a(83178),i=a(47629),s=e([i]);i=(s.then?(await s)():s)[0];class c{static async createWalletForOrganization(e){try{let t=await n.db.aIWallet.findUnique({where:{organizationId:e}});if(t)return t;return await n.db.aIWallet.create({data:{organizationId:e,balance:new i.Decimal(0),totalSpent:new i.Decimal(0),totalRecharged:new i.Decimal(0),transactionCount:0,currency:"USD",lowBalanceThreshold:new i.Decimal(10),alertsEnabled:!0}})}catch(e){throw console.error("Error creating AI wallet:",e),Error("Failed to create AI wallet")}}static async getOrCreateWallet(e){try{let t=await n.db.aIWallet.findUnique({where:{organizationId:e}});return t||(t=await this.createWalletForOrganization(e)),t}catch(e){throw console.error("Error getting wallet:",e),Error("Failed to get wallet")}}static async hasSufficientBalance(e,t){try{return(await this.getOrCreateWallet(e)).balance.toNumber()>=1.3*t}catch(e){return console.error("Error checking balance:",e),!1}}static async processAIUsage(e){try{return await n.db.$transaction(async t=>{let a=await t.aIWallet.findUnique({where:{organizationId:e.organizationId}});if(!a)throw Error("Wallet not found");let r=new i.Decimal(e.providerCost),n=r.times(1.3),s=a.balance;if(s.lessThan(n))throw Error(`Insufficient balance. Required: $${n}, Available: $${s}`);let c=s.minus(n),d=await t.aITransaction.create({data:{walletId:a.id,usageType:e.usageType,providerName:e.providerName,modelUsed:e.modelUsed,providerCost:r,clientCost:n,margin:new i.Decimal(.3),inputTokens:e.inputTokens,outputTokens:e.outputTokens,totalTokens:(e.inputTokens||0)+(e.outputTokens||0),processingTime:e.processingTime,description:e.description,metadata:e.metadata,userId:e.userId,userName:e.userName,balanceAfter:c}});return await t.aIWallet.update({where:{id:a.id},data:{balance:c,totalSpent:a.totalSpent.plus(n),transactionCount:a.transactionCount+1,updatedAt:new Date}}),await t.financialTransaction.create({data:{organizationId:e.organizationId,type:o.TransactionType.AI_USAGE_DEDUCTION,amount:n,currency:a.currency,description:`AI Usage: ${e.usageType} - ${e.providerName}`,reference:d.id,aiTransactionId:d.id,balanceBefore:s,balanceAfter:c,userId:e.userId,userName:e.userName,metadata:{usageType:e.usageType,providerName:e.providerName,modelUsed:e.modelUsed,tokens:(e.inputTokens||0)+(e.outputTokens||0)}}}),d})}catch(e){throw console.error("Error processing AI usage:",e),Error(`Failed to process AI usage: ${e.message}`)}}static async rechargeWallet(e){try{return await n.db.$transaction(async t=>{let a=await this.getOrCreateWallet(e.organizationId),r=new i.Decimal(e.amount),n=a.balance,s=n.plus(r);return await t.aIWallet.update({where:{id:a.id},data:{balance:s,totalRecharged:a.totalRecharged.plus(r),transactionCount:a.transactionCount+1,updatedAt:new Date}}),await t.financialTransaction.create({data:{organizationId:e.organizationId,type:o.TransactionType.WALLET_RECHARGE,amount:r,currency:e.currency,description:e.description||`Wallet recharge via ${e.paymentProvider}`,reference:e.paymentReference,paymentProvider:e.paymentProvider,balanceBefore:n,balanceAfter:s,userId:e.userId,userName:e.userName,metadata:{paymentProvider:e.paymentProvider,paymentReference:e.paymentReference}}})})}catch(e){throw console.error("Error recharging wallet:",e),Error("Failed to recharge wallet")}}static async getWalletStats(e){try{let t=await this.getOrCreateWallet(e),a=await n.db.aITransaction.findMany({where:{wallet:{organizationId:e}},orderBy:{createdAt:"desc"},take:10}),r=t.balance.lessThanOrEqualTo(t.lowBalanceThreshold);return{balance:t.balance.toNumber(),totalSpent:t.totalSpent.toNumber(),totalRecharged:t.totalRecharged.toNumber(),transactionCount:t.transactionCount,lowBalanceAlert:r,recentTransactions:a}}catch(e){throw console.error("Error getting wallet stats:",e),Error("Failed to get wallet stats")}}static async getAITransactionHistory(e,t=1,a=50){try{let[r,o]=await Promise.all([n.db.aITransaction.findMany({where:{wallet:{organizationId:e}},orderBy:{createdAt:"desc"},skip:(t-1)*a,take:a}),n.db.aITransaction.count({where:{wallet:{organizationId:e}}})]);return{transactions:r,total:o}}catch(e){throw console.error("Error getting AI transaction history:",e),Error("Failed to get transaction history")}}static async getFinancialHistory(e,t=1,a=50){try{let[r,o]=await Promise.all([n.db.financialTransaction.findMany({where:{organizationId:e},orderBy:{createdAt:"desc"},skip:(t-1)*a,take:a}),n.db.financialTransaction.count({where:{organizationId:e}})]);return{transactions:r,total:o}}catch(e){throw console.error("Error getting financial history:",e),Error("Failed to get financial history")}}static async updateLowBalanceSettings(e,t,a){try{let r=await this.getOrCreateWallet(e);return await n.db.aIWallet.update({where:{id:r.id},data:{lowBalanceThreshold:new i.Decimal(t),alertsEnabled:a}})}catch(e){throw console.error("Error updating low balance settings:",e),Error("Failed to update settings")}}}r()}catch(e){r(e)}})},27769:(e,t,a)=>{a.d(t,{B:()=>o});var r=a(83178);class o{static async executeQuery(e,t){let a=await r._.organizationIntegration.findMany({where:{organizationId:e,integration:{type:"ECOMMERCE"},status:"CONNECTED"},include:{integration:!0}});if(0===a.length)throw Error("No hay tiendas conectadas");let o=a[0];switch(t.type){case"product":return await this.queryProducts(o,t.params);case"order":return await this.queryOrders(o,t.params);case"customer":return await this.queryCustomers(o,t.params);case"inventory":return await this.queryInventory(o,t.params);default:throw Error("Tipo de consulta no soportado")}}static async queryProducts(e,t){let a=JSON.parse(e.credentials);switch(e.integration.platform){case"SHOPIFY":return await this.queryShopifyProducts(a,t);case"WOOCOMMERCE":return await this.queryWooCommerceProducts(a,t);case"TIENDANUBE":return await this.queryTiendaNubeProducts(a,t);default:throw Error("Plataforma no soportada")}}static async queryOrders(e,t){let a=JSON.parse(e.credentials);switch(e.integration.platform){case"SHOPIFY":return await this.queryShopifyOrders(a,t);case"WOOCOMMERCE":return await this.queryWooCommerceOrders(a,t);case"TIENDANUBE":return await this.queryTiendaNubeOrders(a,t);default:throw Error("Plataforma no soportada")}}static async queryCustomers(e,t){let a=JSON.parse(e.credentials);switch(e.integration.platform){case"SHOPIFY":return await this.queryShopifyCustomers(a,t);case"WOOCOMMERCE":return await this.queryWooCommerceCustomers(a,t);case"TIENDANUBE":return await this.queryTiendaNubeCustomers(a,t);default:throw Error("Plataforma no soportada")}}static async queryInventory(e,t){let a=JSON.parse(e.credentials);if("SHOPIFY"===e.integration.platform)return await this.queryShopifyInventory(a,t);throw Error("Consulta de inventario no soportada para esta plataforma")}static async queryShopifyProducts(e,t){let{shop_domain:a,access_token:r}=e,o=new URLSearchParams;t.search&&o.append("title",t.search),t.status&&o.append("status",t.status),o.append("limit",t.limit||"10");let n=`https://${a}/admin/api/2023-10/products.json?${o}`,i=await fetch(n,{headers:{"X-Shopify-Access-Token":r,"Content-Type":"application/json"}});if(!i.ok)throw Error(`Error consultando productos de Shopify: ${i.statusText}`);return(await i.json()).products.map(e=>({id:e.id.toString(),name:e.title,description:e.body_html,price:e.variants?.[0]?.price?parseFloat(e.variants[0].price):0,currency:"USD",stock:e.variants?.[0]?.inventory_quantity||0,sku:e.variants?.[0]?.sku,images:e.images?.map(e=>e.src)||[],categories:e.product_type?[e.product_type]:[],status:"active"===e.status?"active":"inactive",url:`https://${a.split(".")[0]}.com/products/${e.handle}`}))}static async queryShopifyOrders(e,t){let{shop_domain:a,access_token:r}=e,o=new URLSearchParams;t.status&&o.append("status",t.status),t.customer_email&&o.append("email",t.customer_email),t.order_number&&o.append("name",t.order_number),o.append("limit",t.limit||"10");let n=`https://${a}/admin/api/2023-10/orders.json?${o}`,i=await fetch(n,{headers:{"X-Shopify-Access-Token":r,"Content-Type":"application/json"}});if(!i.ok)throw Error(`Error consultando pedidos de Shopify: ${i.statusText}`);return(await i.json()).orders.map(e=>({id:e.id.toString(),orderNumber:e.name,status:e.financial_status,total:parseFloat(e.total_price),currency:e.currency,customerEmail:e.email,customerName:e.customer?.first_name&&e.customer?.last_name?`${e.customer.first_name} ${e.customer.last_name}`:e.customer?.email,items:e.line_items?.map(e=>({productId:e.product_id?.toString(),productName:e.name,quantity:e.quantity,price:parseFloat(e.price)}))||[],shippingAddress:e.shipping_address,createdAt:new Date(e.created_at),updatedAt:new Date(e.updated_at)}))}static async queryShopifyCustomers(e,t){let{shop_domain:a,access_token:r}=e,o=new URLSearchParams;t.email&&o.append("email",t.email),t.search&&o.append("query",t.search),o.append("limit",t.limit||"10");let n=`https://${a}/admin/api/2023-10/customers.json?${o}`,i=await fetch(n,{headers:{"X-Shopify-Access-Token":r,"Content-Type":"application/json"}});if(!i.ok)throw Error(`Error consultando clientes de Shopify: ${i.statusText}`);return(await i.json()).customers.map(e=>({id:e.id.toString(),email:e.email,name:e.first_name&&e.last_name?`${e.first_name} ${e.last_name}`:void 0,phone:e.phone,totalOrders:e.orders_count,totalSpent:e.total_spent?parseFloat(e.total_spent):void 0,createdAt:new Date(e.created_at),lastOrderAt:e.last_order_date?new Date(e.last_order_date):void 0}))}static async queryShopifyInventory(e,t){let{shop_domain:a,access_token:r}=e,o=`https://${a}/admin/api/2023-10/inventory_levels.json`,n=await fetch(o,{headers:{"X-Shopify-Access-Token":r,"Content-Type":"application/json"}});if(!n.ok)throw Error(`Error consultando inventario de Shopify: ${n.statusText}`);return(await n.json()).inventory_levels}static async queryWooCommerceProducts(e,t){throw Error("WooCommerce products query no implementada a\xfan")}static async queryWooCommerceOrders(e,t){throw Error("WooCommerce orders query no implementada a\xfan")}static async queryWooCommerceCustomers(e,t){throw Error("WooCommerce customers query no implementada a\xfan")}static async queryTiendaNubeProducts(e,t){throw Error("TiendaNube products query no implementada a\xfan")}static async queryTiendaNubeOrders(e,t){throw Error("TiendaNube orders query no implementada a\xfan")}static async queryTiendaNubeCustomers(e,t){throw Error("TiendaNube customers query no implementada a\xfan")}static detectEcommerceIntent(e){let t=e.toLowerCase();return t.includes("producto")||t.includes("stock")||t.includes("precio")||t.includes("disponible")||t.includes("cat\xe1logo")?{needsEcommerce:!0,queryType:"product",params:{search:this.extractProductName(e),limit:5}}:t.includes("pedido")||t.includes("orden")||t.includes("compra")||t.includes("#")?{needsEcommerce:!0,queryType:"order",params:{order_number:this.extractOrderNumber(e),limit:5}}:t.includes("cliente")||t.includes("comprador")||t.includes("historial de compras")?{needsEcommerce:!0,queryType:"customer",params:{search:e,limit:5}}:{needsEcommerce:!1}}static extractProductName(e){let t=e.split(" "),a=["producto","item","art\xedculo"];for(let e=0;e<t.length;e++)if(a.some(a=>t[e].toLowerCase().includes(a)))return t.slice(e+1).join(" ");return e}static extractOrderNumber(e){let t=e.match(/#(\w+)|(?:orden|pedido)\s+(\w+)/i);return t?t[1]||t[2]:void 0}}}};