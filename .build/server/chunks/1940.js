"use strict";exports.id=1940,exports.ids=[1940,9116],exports.modules={25522:(e,n,a)=>{a.d(n,{ZR:()=>f,l8:()=>p});var t=a(53524),o=a(76780),s=a(82770),i=a(21841),r=a(48872);let l=new t.PrismaClient,c=new s.ZP({baseURL:process.env.ABACUSAI_BASE_URL||"https://chatllm.abacus.ai/v1",apiKey:process.env.ABACUSAI_API_KEY||""}),d=new i.S3Client({}),u=process.env.AWS_BUCKET_NAME||"";process.env.AWS_FOLDER_PREFIX;class m{constructor(e,n,a){this.organizationId=e,this.userId=n,this.userName=a,this.knowledgeSearcher=new o.KnowledgeSearcher(e)}async resolveQuery(e,n,a={}){let t=Date.now();try{console.log("\uD83D\uDD0D Buscando en Knowledge Base:",e);let o=await this.knowledgeSearcher.searchKnowledge(e,{maxResults:a.maxResults||5,minSimilarity:a.minSimilarity||.75});if(0===o.results.length)return{responseText:"Lo siento, no tengo informaci\xf3n espec\xedfica sobre esa consulta. \xbfPodr\xedas ser m\xe1s espec\xedfico o contactar con un agente?",filesToSend:[],knowledgeUsed:[],confidence:.1,processingTime:Date.now()-t};console.log("\uD83E\uDD16 Generando respuesta inteligente...");let s=await this.generateIntelligentResponse(e,o.results,a),i=await this.determineFilesToSend(o.results);await this.logResolution(n,e,o,s,i);let r=Date.now()-t;return console.log("✅ Resoluci\xf3n completada en",r,"ms"),{responseText:s.text,filesToSend:i,knowledgeUsed:o.results.map(e=>({sourceId:e.sourceId,sourceName:e.sourceName,content:e.content,similarity:e.similarity})),confidence:s.confidence,processingTime:r}}catch(e){return console.error("❌ Error en resoluci\xf3n:",e),{responseText:"Disculpa, tengo dificultades t\xe9cnicas en este momento. Un agente te ayudar\xe1 pronto.",filesToSend:[],knowledgeUsed:[],confidence:0,processingTime:Date.now()-t}}}async generateIntelligentResponse(e,n,a){let t=n.map((e,n)=>`[Fuente ${n+1}: ${e.sourceName} (relevancia: ${Math.round(100*e.similarity)}%)]
${e.content}`).join("\n\n"),o=a.responseStyle||"professional",s=a.maxResponseLength||500,i=this.createResponsePrompt(e,t,o,s,n);try{let e=await c.chat.completions.create({model:"gpt-4o-mini",messages:[{role:"system",content:this.getSystemPromptForResolution(o)},{role:"user",content:i}],temperature:.3,max_tokens:Math.min(800,s+100)}),a=e.choices[0]?.message?.content||"No pude generar una respuesta adecuada.",t=n.reduce((e,n)=>e+n.similarity,0)/n.length;return{text:a,confidence:Math.min(.95,t)}}catch(e){return console.error("Error generando respuesta:",e),{text:"Bas\xe1ndome en la informaci\xf3n disponible, puedo ayudarte con tu consulta. Te he preparado algunos documentos relevantes que contienen informaci\xf3n detallada.",confidence:.6}}}async determineFilesToSend(e){let n=[],a=[...new Set(e.map(e=>e.sourceId))];for(let t of(await l.knowledgeSource.findMany({where:{id:{in:a},type:"FILE",fileUrl:{not:null},status:"ACTIVE"},select:{id:!0,name:!0,fileUrl:!0,originalFileName:!0,fileMimeType:!0}}))){let a=e.find(e=>e.sourceId===t.id);if(a&&a.similarity>=.8){let e=`Este documento contiene informaci\xf3n espec\xedfica sobre tu consulta (relevancia: ${Math.round(100*a.similarity)}%)`;n.push({sourceId:t.id,sourceName:t.name,fileUrl:t.fileUrl,fileName:t.originalFileName||`${t.name}.pdf`,mimeType:t.fileMimeType||"application/pdf",reason:e})}}return n.slice(0,3)}async logResolution(e,n,a,t,o){try{await l.knowledgeUsage.create({data:{organizationId:this.organizationId,userId:this.userId,userName:this.userName,conversationId:e,query:n,queryType:"ai_resolution",resultsFound:a.totalResults,resultsUsed:a.results.length,avgSimilarity:a.results.length>0?a.results.reduce((e,n)=>e+n.similarity,0)/a.results.length:0,sourcesConsulted:[...new Set(a.results.map(e=>e.sourceId))],chunksRetrieved:a.results.map(e=>e.chunkId),processingTime:a.processingTime,responseGenerated:!0,metadata:{responseLength:t.text.length,confidence:t.confidence,filesAttached:o.length,filesSent:o.map(e=>({sourceId:e.sourceId,fileName:e.fileName}))}}});let s=[...new Set(a.results.map(e=>e.sourceId))];s.length>0&&await l.knowledgeSource.updateMany({where:{id:{in:s}},data:{usageCount:{increment:1},lastUsedAt:new Date}})}catch(e){console.error("Error registrando resoluci\xf3n:",e)}}createResponsePrompt(e,n,a,t,o){let s=o.some(e=>e.metadata?.type==="FILE");return`
Consulta del cliente: "${e}"

Informaci\xf3n encontrada en nuestra base de conocimiento:
${n}

INSTRUCCIONES:
1. Responde de manera ${a} y \xfatil a la consulta del cliente
2. Usa \xdaNICAMENTE la informaci\xf3n proporcionada arriba - no inventes datos
3. Si la informaci\xf3n es suficiente, da una respuesta completa y detallada
4. Si la informaci\xf3n es parcial, explica qu\xe9 informaci\xf3n tienes y sugiere contactar a un agente para m\xe1s detalles
5. M\xe1ximo ${t} caracteres
6. ${s?"IMPORTANTE: Menciona que adjuntar\xe1s documentos relevantes con informaci\xf3n adicional":""}
7. S\xe9 natural y humano, evita sonar rob\xf3tico
8. Si hay m\xfaltiples fuentes, integra la informaci\xf3n de manera coherente

La respuesta debe ser directa, \xfatil y enfocada en resolver la necesidad del cliente.
`}getSystemPromptForResolution(e){let n={formal:"Usa un tono formal y profesional. Evita contracciones.",casual:"Usa un tono amigable y cercano. Puedes usar contracciones.",professional:"Usa un tono profesional pero accesible. Equilibra formalidad con calidez."};return`Eres un asistente de atenci\xf3n al cliente especializado en proporcionar informaci\xf3n precisa y \xfatil. Tu objetivo es resolver las consultas de los clientes usando la informaci\xf3n disponible en la base de conocimiento de la empresa.

Caracter\xedsticas clave:
- ${n[e]||n.professional}
- Siempre honesto sobre las limitaciones de la informaci\xf3n disponible
- Enfocado en ser resolutivo y \xfatil
- Capaz de sugerir documentos adicionales cuando sea apropiado
- Comprensivo con las necesidades del cliente

NUNCA inventes informaci\xf3n que no est\xe1 en el contexto proporcionado.`}async generateDownloadUrls(e){let n=[];for(let a of e)try{let e=a.fileUrl.replace(`https://${u}.s3.amazonaws.com/`,""),t=await (0,r.e)(d,new i.GetObjectCommand({Bucket:u,Key:e}),{expiresIn:3600});n.push({...a,downloadUrl:t})}catch(e){console.error(`Error generando URL para archivo ${a.fileName}:`,e)}return n}}function p(e,n,a){return new m(e,n,a)}async function f(e,n,a,t,o,s){let i=p(e,n,a);return await i.resolveQuery(t,o,s)}},79116:(e,n,a)=>{var t;a.d(n,{Eb:()=>o,FQ:()=>s,VO:()=>i,Vt:()=>r,qm:()=>l}),a(53524),function(e){e.INSUFFICIENT_BALANCE="INSUFFICIENT_BALANCE",e.NO_PROVIDER_AVAILABLE="NO_PROVIDER_AVAILABLE",e.PROVIDER_ERROR="PROVIDER_ERROR",e.INVALID_REQUEST="INVALID_REQUEST",e.RATE_LIMIT_EXCEEDED="RATE_LIMIT_EXCEEDED",e.INTERNAL_ERROR="INTERNAL_ERROR"}(t||(t={}));let o={pdf:["application/pdf"],document:["application/msword","application/vnd.openxmlformats-officedocument.wordprocessingml.document"],text:["text/plain","text/markdown","text/csv"],web:["text/html"]},s=52428800,i=1e3,r=100,l="text-embedding-3-small"}};