"use strict";exports.id=6780,exports.ids=[6780],exports.modules={76780:(e,t,r)=>{r.r(t),r.d(t,{KnowledgeProcessor:()=>u,KnowledgeSearcher:()=>h,createKnowledgeProcessor:()=>g,createKnowledgeSearcher:()=>m});var a=r(53524),o=r(82770),n=r(21841),s=r(79116);let i=new a.PrismaClient,c=new o.ZP({baseURL:process.env.ABACUSAI_BASE_URL||"https://chatllm.abacus.ai/v1",apiKey:process.env.ABACUSAI_API_KEY||""}),l=new n.S3Client({}),d=process.env.AWS_BUCKET_NAME||"";process.env.AWS_FOLDER_PREFIX;class u{constructor(e,t,r){this.organizationId=e,this.userId=t,this.userName=r}async processKnowledgeSource(e){try{let t=await i.knowledgeSource.findUnique({where:{id:e}});if(!t)throw Error("Fuente de conocimiento no encontrada");await i.knowledgeSource.update({where:{id:e},data:{status:a.KnowledgeSourceStatus.PROCESSING,lastError:null,retryCount:{increment:1}}});let r=t.textContent;if(t.type===a.KnowledgeSourceType.FILE&&t.fileUrl?r=await this.extractTextFromFile(t.fileUrl,t.fileMimeType||""):t.type===a.KnowledgeSourceType.URL&&t.sourceUrl&&(r=await this.extractTextFromURL(t.sourceUrl)),!r||r.trim().length<10)throw Error("No se pudo extraer contenido v\xe1lido");await i.knowledgeSource.update({where:{id:e},data:{textContent:r,status:a.KnowledgeSourceStatus.CHUNKING}});let o=this.splitIntoChunks(r,t.chunkSize,t.chunkOverlap),n=o.length;await i.knowledgeSource.update({where:{id:e},data:{totalChunks:n,status:a.KnowledgeSourceStatus.EMBEDDING}});let s=0,c=0;for(let t=0;t<o.length;t++)try{let r=await this.processChunk(e,o[t],t);await this.generateEmbeddingForChunk(r.id,o[t])&&c++,s++,await i.knowledgeSource.update({where:{id:e},data:{processedChunks:s}})}catch(r){console.error(`Error procesando chunk ${t}:`,r),await i.knowledgeSource.update({where:{id:e},data:{failedChunks:{increment:1}}})}let l=this.calculateQuality(r);return await i.knowledgeSource.update({where:{id:e},data:{status:a.KnowledgeSourceStatus.ACTIVE,processedAt:new Date,contentQuality:l}}),{success:!0,chunksProcessed:s,embeddings:c}}catch(t){return console.error("Error procesando fuente de conocimiento:",t),await i.knowledgeSource.update({where:{id:e},data:{status:a.KnowledgeSourceStatus.ERROR,lastError:t instanceof Error?t.message:"Error desconocido"}}),{success:!1,chunksProcessed:0,embeddings:0,error:t instanceof Error?t.message:"Error desconocido"}}}async extractTextFromFile(e,t){try{if("text/plain"===t||"text/markdown"===t||"text/csv"===t){let t=e.replace(`https://${d}.s3.amazonaws.com/`,""),r=new n.GetObjectCommand({Bucket:d,Key:t}),a=await l.send(r);return await a.Body?.transformToString()||""}if("application/pdf"===t)return`[Contenido PDF - Requiere procesamiento especializado]
        
        Este archivo PDF contiene informaci\xf3n importante para el negocio.
        Para una extracci\xf3n completa, se requiere implementar un procesador PDF espec\xedfico.`;if(t.includes("word")||t.includes("document"))return`[Contenido DOC/DOCX - Requiere procesamiento especializado]
        
        Este documento Word contiene informaci\xf3n importante para el negocio.
        Para una extracci\xf3n completa, se requiere implementar un procesador de documentos espec\xedfico.`;throw Error(`Tipo de archivo no soportado: ${t}`)}catch(e){throw console.error("Error extrayendo texto del archivo:",e),Error("No se pudo extraer el texto del archivo")}}async extractTextFromURL(e){try{let t=await fetch(e,{headers:{"User-Agent":"COMODIN IA Knowledge Processor 1.0"}});if(!t.ok)throw Error(`HTTP ${t.status}: ${t.statusText}`);let r=(await t.text()).replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi,"").replace(/<style\b[^<]*(?:(?!<\/style>)<[^<]*)*<\/style>/gi,"").replace(/<[^>]*>/g,"").replace(/&nbsp;/g," ").replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"').replace(/&#39;/g,"'").replace(/\s+/g," ").trim();if(r.length<100)throw Error("Contenido muy corto o vac\xedo");return r}catch(e){throw console.error("Error extrayendo contenido de URL:",e),Error(`No se pudo extraer contenido de la URL: ${e instanceof Error?e.message:"Error desconocido"}`)}}async extractMetadata(e){return{name:e.name,size:e.size,type:e.type,lastModified:new Date(e.lastModified),language:this.detectLanguage(e.name)}}splitIntoChunks(e,t=s.VO,r=s.Vt){let a=[],o=e.split(/[.!?]+/).filter(e=>e.trim().length>0),n="",i=0;for(let e of o)i+e.trim().length>t&&n.length>0?(a.push(n.trim()),i=(n=n.split(" ").slice(-Math.floor(r/10)).join(" ")+" "+e.trim()).length):(n+=(n?" ":"")+e.trim(),i=n.length);return n.trim().length>0&&a.push(n.trim()),0===a.length&&e.trim().length>0&&a.push(e.trim()),a}detectLanguage(e){let t=["el","la","de","que","y","en","un","es","se","no","te","lo","le","da","su","por","son","con","para","como","pero","m\xe1s","muy","todo","esta","est\xe1","hasta"],r=["the","be","to","of","and","a","in","that","have","it","for","not","on","with","he","as","you","do","at","this","but","his","by","from","they"],a=e.toLowerCase().split(/\s+/).slice(0,100),o=0,n=0;return a.forEach(e=>{t.includes(e)&&o++,r.includes(e)&&n++}),o>n?"es":"en"}calculateQuality(e){if(!e||0===e.trim().length)return 0;let t=.5,r=e.length;r>100&&r<5e4&&(t+=.2);let a=e.toLowerCase().split(/\s+/);return t+=new Set(a).size/a.length*.2,e.split(/[.!?]+/).filter(e=>e.trim().length>0).length>1&&(t+=.1),Math.min(1,Math.max(0,t+=e.replace(/[^\w\s.,;:!?()""''â€”-]/g,"").length/e.length*.1))}async processChunk(e,t,r){let o=t.split(/\s+/).length,n=t.length,s=this.detectLanguage(t),c=this.calculateQuality(t);return await i.knowledgeChunk.create({data:{sourceId:e,content:t,chunkIndex:r,status:a.ChunkProcessingStatus.COMPLETED,wordCount:o,characterCount:n,language:s,contentQuality:c}})}async generateEmbeddingForChunk(e,t){try{let r=Date.now(),a=await c.embeddings.create({model:s.qm,input:t.slice(0,8e3)}),o=a.data[0]?.embedding;if(!o)throw Error("No se pudo generar el embedding");let n=Date.now()-r,l=o.length;return await i.knowledgeEmbedding.create({data:{chunkId:e,modelUsed:s.qm,embeddingVersion:"1.0",dimensions:l,embedding:o,processingTime:n,providerUsed:"openai",quality:.9,confidence:.95}})}catch(t){return console.error("Error generando embedding:",t),await i.knowledgeChunk.update({where:{id:e},data:{status:a.ChunkProcessingStatus.FAILED,processingError:t instanceof Error?t.message:"Error generando embedding"}}),null}}}class h{constructor(e){this.organizationId=e}async searchKnowledge(e,t={}){let r=Date.now();try{let a=await this.generateQueryEmbedding(e),o=await this.findSimilarChunks(a,t),n=Date.now()-r;return{results:o,totalResults:o.length,processingTime:n}}catch(e){throw console.error("Error en b\xfasqueda sem\xe1ntica:",e),e}}async generateQueryEmbedding(e){let t=await c.embeddings.create({model:s.qm,input:e}),r=t.data[0]?.embedding;if(!r)throw Error("No se pudo generar embedding para la consulta");return r}async findSimilarChunks(e,t){return(await i.knowledgeChunk.findMany({where:{source:{organizationId:this.organizationId,status:a.KnowledgeSourceStatus.ACTIVE,...t.sourceTypes&&{type:{in:t.sourceTypes}}},status:a.ChunkProcessingStatus.COMPLETED},include:{source:{select:{id:!0,name:!0,type:!0,tags:!0}},embeddings:{where:{modelUsed:s.qm},take:1}},take:100})).filter(e=>e.embeddings.length>0).map(t=>{let r=t.embeddings[0].embedding,a=this.calculateCosineSimilarity(e,r);return{chunkId:t.id,sourceId:t.source.id,sourceName:t.source.name,content:t.content.slice(0,500),similarity:a,metadata:{type:t.source.type,tags:t.source.tags,wordCount:t.wordCount,quality:t.contentQuality?.toNumber()}}}).filter(e=>e.similarity>=(t.minSimilarity||.7)).sort((e,t)=>t.similarity-e.similarity).slice(0,t.maxResults||10)}calculateCosineSimilarity(e,t){if(e.length!==t.length)return 0;let r=0,a=0,o=0;for(let n=0;n<e.length;n++)r+=e[n]*t[n],a+=e[n]*e[n],o+=t[n]*t[n];return 0===a||0===o?0:r/(Math.sqrt(a)*Math.sqrt(o))}}async function g(e,t,r){return new u(e,t,r)}async function m(e){return new h(e)}}};