"use strict";(()=>{var e={};e.id=2025,e.ids=[2025],e.modules={53524:e=>{e.exports=require("@prisma/client")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},86624:e=>{e.exports=require("querystring")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},44519:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>y,patchFetch:()=>q,requestAsyncStorage:()=>x,routeModule:()=>g,serverHooks:()=>v,staticGenerationAsyncStorage:()=>f});var a={};r.r(a),r.d(a,{GET:()=>d,POST:()=>m});var s=r(79182),n=r(72007),o=r(56719),i=r(93442),u=r(57978),c=r(11826),p=r(83178),l=r(25590);async function d(e){try{let t=await (0,u.getServerSession)(c.L);if(!t?.user?.organizationId)return i.NextResponse.json({error:"No autorizado"},{status:401});if(!(0,l.N$)(t.user.role,l.y3.VIEW_CAMPAIGNS))return i.NextResponse.json({error:"Permisos insuficientes"},{status:403});let{searchParams:r}=new URL(e.url),a=r.get("status"),s=r.get("type"),n=parseInt(r.get("page")||"1"),o=parseInt(r.get("limit")||"20"),d=(n-1)*o,m={organizationId:t.user.organizationId,...a&&{status:a},...s&&{type:s}},[g,x]=await Promise.all([p._.campaign.findMany({where:m,include:{template:{select:{name:!0,status:!0,category:!0}}},orderBy:[{createdAt:"desc"}],skip:d,take:o}),p._.campaign.count({where:m})]),f=g.map(e=>({...e,templateName:e.template.name,deliveryRate:e.totalRecipients>0?e.messagesDelivered/e.totalRecipients*100:0,readRate:e.messagesDelivered>0?e.messagesRead/e.messagesDelivered*100:0}));return i.NextResponse.json({success:!0,data:f,pagination:{page:n,limit:o,total:x,totalPages:Math.ceil(x/o)}})}catch(e){return console.error("Error al obtener campa\xf1as:",e),i.NextResponse.json({error:"Error interno del servidor"},{status:500})}}async function m(e){try{let t=await (0,u.getServerSession)(c.L);if(!t?.user?.organizationId)return i.NextResponse.json({error:"No autorizado"},{status:401});if(!(0,l.N$)(t.user.role,l.y3.CREATE_CAMPAIGNS))return i.NextResponse.json({error:"Permisos insuficientes"},{status:403});let{name:r,description:a,type:s="IMMEDIATE",templateId:n,messageVariables:o,audienceFilters:d,maxRecipients:m,scheduledFor:g,timezone:x="America/Mexico_City",sendRate:f=10,batchSize:v=100,budgetLimit:y}=await e.json();if(!r||!n||!d||0===d.length)return i.NextResponse.json({error:"Faltan campos requeridos: name, templateId, audienceFilters"},{status:400});if(!await p._.messageTemplate.findFirst({where:{id:n,organizationId:t.user.organizationId,status:"APPROVED",isActive:!0}}))return i.NextResponse.json({error:"Plantilla no encontrada o no est\xe1 aprobada"},{status:404});let q=await p._.campaign.create({data:{organizationId:t.user.organizationId,name:r,description:a,type:s,templateId:n,messageVariables:o,scheduledFor:g?new Date(g):null,timezone:x,sendRate:f,batchSize:v,budgetLimit:y,maxRecipients:m,createdBy:t.user.id,createdByName:t.user.name||"Usuario",audienceFilters:{create:d.map((e,t)=>({filterType:e.type,operator:e.operator||"AND",tagNames:e.configuration.tagNames||[],channelIds:e.configuration.channelIds||[],vipStatus:e.configuration.vipStatus,lastContactAfter:e.configuration.lastContactAfter,lastContactBefore:e.configuration.lastContactBefore,conversationStatuses:e.configuration.conversationStatuses||[],includeInactive:e.configuration.includeInactive||!1,metadata:e.configuration,filterOrder:t+1}))}},include:{template:!0,audienceFilters:!0}});return i.NextResponse.json({success:!0,data:q,message:"Campa\xf1a creada exitosamente"},{status:201})}catch(e){return console.error("Error al crear campa\xf1a:",e),i.NextResponse.json({error:"Error interno del servidor"},{status:500})}}let g=new s.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/campaigns/route",pathname:"/api/campaigns",filename:"route",bundlePath:"app/api/campaigns/route"},resolvedPagePath:"/home/ubuntu/comodin_ia/app/app/api/campaigns/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:x,staticGenerationAsyncStorage:f,serverHooks:v}=g,y="/api/campaigns/route";function q(){return(0,o.patchFetch)({serverHooks:v,staticGenerationAsyncStorage:f})}}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[4372,7329,1472,7609,1826],()=>r(44519));module.exports=a})();