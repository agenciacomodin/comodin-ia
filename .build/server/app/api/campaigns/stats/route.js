"use strict";(()=>{var e={};e.id=8956,e.ids=[8956],e.modules={53524:e=>{e.exports=require("@prisma/client")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},86624:e=>{e.exports=require("querystring")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},25909:(e,t,s)=>{s.r(t),s.d(t,{originalPathname:()=>v,patchFetch:()=>q,requestAsyncStorage:()=>l,routeModule:()=>g,serverHooks:()=>h,staticGenerationAsyncStorage:()=>x});var a={};s.r(a),s.d(a,{GET:()=>d});var r=s(79182),n=s(72007),i=s(56719),o=s(93442),p=s(57978),u=s(11826),m=s(83178),c=s(25590);async function d(e){try{let e=await (0,p.getServerSession)(u.L);if(!e?.user?.organizationId)return o.NextResponse.json({error:"No autorizado"},{status:401});if(!(0,c.N$)(e.user.role,c.y3.VIEW_CAMPAIGNS))return o.NextResponse.json({error:"Permisos insuficientes"},{status:403});let t=e.user.organizationId,[s,a,r,n]=await Promise.all([m._.campaign.count({where:{organizationId:t}}),m._.campaign.count({where:{organizationId:t,status:{in:["SENDING","SCHEDULED"]}}}),m._.campaign.count({where:{organizationId:t,status:"COMPLETED"}}),m._.campaign.aggregate({where:{organizationId:t},_sum:{messagesSent:!0,messagesDelivered:!0,messagesRead:!0,actualCost:!0},_avg:{messagesSent:!0,messagesDelivered:!0}})]),i=n._sum.messagesSent||0,d=n._sum.messagesDelivered||0,g=n._sum.messagesRead||0,l=n._sum.actualCost||0,x=(await m._.messageTemplate.findMany({where:{organizationId:t,campaigns:{some:{status:"COMPLETED"}}},include:{campaigns:{where:{status:"COMPLETED"},select:{id:!0,messagesDelivered:!0,totalRecipients:!0}}},orderBy:{usageCount:"desc"},take:5})).map(e=>({templateId:e.id,templateName:e.name,campaignsCount:e.campaigns.length,avgDeliveryRate:e.campaigns.length>0?e.campaigns.reduce((e,t)=>e+(t.totalRecipients>0?t.messagesDelivered/t.totalRecipients*100:0),0)/e.campaigns.length:0})),h=(await m._.campaign.findMany({where:{organizationId:t,OR:[{startedAt:{not:null}},{completedAt:{not:null}},{status:"FAILED"}]},orderBy:{updatedAt:"desc"},take:10,select:{id:!0,name:!0,status:!0,startedAt:!0,completedAt:!0,messagesSent:!0,updatedAt:!0}})).map(e=>({id:e.id,type:"COMPLETED"===e.status?"campaign_completed":"FAILED"===e.status?"campaign_failed":"campaign_started",campaignName:e.name,timestamp:e.completedAt||e.startedAt||e.updatedAt,messagesSent:e.messagesSent})),v={totalCampaigns:s,activeCampaigns:a,completedCampaigns:r,totalMessagesSent:i,totalCostThisMonth:Number(l),avgDeliveryRate:i>0?d/i*100:0,avgReadRate:d>0?g/d*100:0,topPerformingTemplates:x,recentActivity:h};return o.NextResponse.json({success:!0,data:v})}catch(e){return console.error("Error al obtener estad\xedsticas de campa\xf1as:",e),o.NextResponse.json({error:"Error interno del servidor"},{status:500})}}let g=new r.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/campaigns/stats/route",pathname:"/api/campaigns/stats",filename:"route",bundlePath:"app/api/campaigns/stats/route"},resolvedPagePath:"/home/ubuntu/comodin_ia/app/app/api/campaigns/stats/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:l,staticGenerationAsyncStorage:x,serverHooks:h}=g,v="/api/campaigns/stats/route";function q(){return(0,i.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:x})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var s=e=>t(t.s=e),a=t.X(0,[4372,7329,1472,7609,1826],()=>s(25909));module.exports=a})();