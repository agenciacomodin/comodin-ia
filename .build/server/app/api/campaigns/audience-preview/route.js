"use strict";(()=>{var e={};e.id=11,e.ids=[11],e.modules={53524:e=>{e.exports=require("@prisma/client")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},86624:e=>{e.exports=require("querystring")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},60792:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>v,patchFetch:()=>w,requestAsyncStorage:()=>h,routeModule:()=>m,serverHooks:()=>f,staticGenerationAsyncStorage:()=>x});var r={};a.r(r),a.d(r,{POST:()=>d});var n=a(79182),s=a(72007),i=a(56719),o=a(93442),u=a(57978),c=a(11826),p=a(83178),l=a(25590);async function d(e){try{let t=await (0,u.getServerSession)(c.L);if(!t?.user?.organizationId)return o.NextResponse.json({error:"No autorizado"},{status:401});if(!(0,l.N$)(t.user.role,l.y3.VIEW_AUDIENCE_PREVIEW))return o.NextResponse.json({error:"Permisos insuficientes"},{status:403});let{filters:a,campaignId:r}=await e.json();if(!a||!Array.isArray(a)||0===a.length)return o.NextResponse.json({error:"Se requiere al menos un filtro de audiencia"},{status:400});let n=Date.now(),s={organizationId:t.user.organizationId,status:"ACTIVE"},i=[],d=[];for(let e of a){let a=await g(e,t.user.organizationId);a&&("OR"===e.operator?d.push(a):i.push(a))}i.length>0&&(s.AND=i),d.length>0&&(s.AND?s.AND.push({OR:d}):s.OR=d);let[m,h]=await Promise.all([p._.contact.count({where:s}),p._.contact.findMany({where:s,include:{tags:!0,conversations:{orderBy:{lastMessageAt:"desc"},take:1,select:{lastMessageAt:!0,whatsappChannelId:!0}}},take:20,orderBy:{lastContact:"desc"}})]),x=h.map(e=>({id:e.id,name:e.name,phone:e.phone,isVip:e.isVip,lastContact:e.lastContact,tags:e.tags.map(e=>e.name),channel:e.conversations[0]?.whatsappChannelId||"unknown"})),f=h.filter(e=>e.isVip).length,v={};h.forEach(e=>{let t=e.conversations[0]?.whatsappChannelId||"unknown";v[t]=(v[t]||0)+1});let w={};h.forEach(e=>{e.tags.forEach(e=>{w[e.name]=(w[e.name]||0)+1})});let A=Date.now()-n,N=await p._.campaignAudiencePreview.create({data:{organizationId:t.user.organizationId,campaignId:r,filtersConfig:a,totalContacts:m,contactIds:h.map(e=>e.id),sampleContacts:x,vipCount:f,channelsDistribution:v,tagsDistribution:w,processingTime:A,expiresAt:new Date(Date.now()+864e5),createdBy:t.user.id,createdByName:t.user.name||"Usuario"}});return o.NextResponse.json({success:!0,data:N})}catch(e){return console.error("Error al generar preview de audiencia:",e),o.NextResponse.json({error:"Error interno del servidor"},{status:500})}}async function g(e,t){let{type:a,configuration:r}=e;switch(a){case"INCLUDE_TAG":if(r.tagNames&&r.tagNames.length>0)return{tags:{some:{name:{in:r.tagNames}}}};break;case"EXCLUDE_TAG":if(r.tagNames&&r.tagNames.length>0)return{NOT:{tags:{some:{name:{in:r.tagNames}}}}};break;case"VIP_STATUS":if(null!==r.vipStatus&&void 0!==r.vipStatus)return{isVip:r.vipStatus};break;case"LAST_CONTACT":let n={};if(r.lastContactAfter&&(n.gte=new Date(r.lastContactAfter)),r.lastContactBefore&&(n.lte=new Date(r.lastContactBefore)),Object.keys(n).length>0)return{lastContact:n};break;case"CHANNEL":if(r.channelIds&&r.channelIds.length>0)return{conversations:{some:{whatsappChannelId:{in:r.channelIds}}}};break;case"CONVERSATION_STATUS":if(r.conversationStatuses&&r.conversationStatuses.length>0)return{conversations:{some:{status:{in:r.conversationStatuses}}}}}return null}let m=new n.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/campaigns/audience-preview/route",pathname:"/api/campaigns/audience-preview",filename:"route",bundlePath:"app/api/campaigns/audience-preview/route"},resolvedPagePath:"/home/ubuntu/comodin_ia/app/app/api/campaigns/audience-preview/route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:h,staticGenerationAsyncStorage:x,serverHooks:f}=m,v="/api/campaigns/audience-preview/route";function w(){return(0,i.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:x})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),r=t.X(0,[4372,7329,1472,7609,1826],()=>a(60792));module.exports=r})();