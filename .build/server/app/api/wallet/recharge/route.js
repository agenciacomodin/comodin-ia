"use strict";(()=>{var e={};e.id=8895,e.ids=[8895],e.modules={53524:e=>{e.exports=require("@prisma/client")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},78893:e=>{e.exports=require("buffer")},61282:e=>{e.exports=require("child_process")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},68621:e=>{e.exports=require("punycode")},86624:e=>{e.exports=require("querystring")},76162:e=>{e.exports=require("stream")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},87905:(e,r,t)=>{t.r(r),t.d(r,{originalPathname:()=>w,patchFetch:()=>E,requestAsyncStorage:()=>y,routeModule:()=>g,serverHooks:()=>h,staticGenerationAsyncStorage:()=>_});var a={};t.r(a),t.d(a,{POST:()=>m});var o=t(79182),i=t(72007),n=t(56719),c=t(93442),s=t(57978),u=t(11826),l=t(81157),p=t(19924),d=t(20591);async function m(e){try{let r;let t=await (0,s.getServerSession)(u.L);if(!t?.user?.email)return c.NextResponse.json({error:"Authentication required"},{status:401});let a=await (0,l.uD)(t.user.email);if(!a)return c.NextResponse.json({error:"Organization not found"},{status:404});let o=a.users.find(e=>e.email===t.user.email);if(o?.role!=="PROPIETARIO")return c.NextResponse.json({error:"Insufficient permissions"},{status:403});let{amount:i,currency:n="USD",provider:m="STRIPE"}=await e.json();if(!i||i<=0)return c.NextResponse.json({error:"Invalid amount"},{status:400});if("STRIPE"===m)return r=await p.t.createPaymentCheckoutSession({amount:100*i,currency:n.toLowerCase(),description:`AI Wallet Recharge - $${i}`,organizationId:a.id,customerEmail:t.user.email,successUrl:`${process.env.NEXTAUTH_URL}/facturacion?wallet_recharged=true`,cancelUrl:`${process.env.NEXTAUTH_URL}/facturacion?wallet_recharge_cancelled=true`,metadata:{type:"wallet_recharge",organizationId:a.id,amount:i.toString(),currency:n}}),c.NextResponse.json({success:!0,provider:"stripe",sessionId:r.sessionId,sessionUrl:r.sessionUrl});if("MERCADO_PAGO"===m)return r=await d.M.createPreference({organizationId:a.id,title:`AI Wallet Recharge - $${i}`,price:i,currency:n,description:`Recarga de billetera IA para ${a.name}`,customerEmail:t.user.email,successUrl:`${process.env.NEXTAUTH_URL}/facturacion?wallet_recharged=true`,failureUrl:`${process.env.NEXTAUTH_URL}/facturacion?wallet_recharge_failed=true`,pendingUrl:`${process.env.NEXTAUTH_URL}/facturacion?wallet_recharge_pending=true`,metadata:{type:"wallet_recharge",organizationId:a.id,amount:i.toString(),currency:n}}),c.NextResponse.json({success:!0,provider:"mercado_pago",preferenceId:r.preferenceId,initPoint:r.initPoint});return c.NextResponse.json({error:"Invalid payment provider"},{status:400})}catch(e){return console.error("Error creating recharge session:",e),c.NextResponse.json({error:"Internal server error"},{status:500})}}let g=new o.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/wallet/recharge/route",pathname:"/api/wallet/recharge",filename:"route",bundlePath:"app/api/wallet/recharge/route"},resolvedPagePath:"/home/ubuntu/comodin_ia/app/app/api/wallet/recharge/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:y,staticGenerationAsyncStorage:_,serverHooks:h}=g,w="/api/wallet/recharge/route";function E(){return(0,n.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:_})}},81157:(e,r,t)=>{t.d(r,{uD:()=>o});var a=t(83178);async function o(e){try{let r=await a.db.user.findUnique({where:{email:e},include:{organization:{include:{users:!0}}}});if(!r||!r.organization)return null;return r.organization}catch(e){return console.error("Error getting user organization:",e),null}}},20591:(e,r,t)=>{t.d(r,{M:()=>s});var a=t(79520);let o=new a.f7({accessToken:process.env.MERCADO_PAGO_ACCESS_TOKEN,options:{timeout:5e3}}),i=new a.kX(o),n=new a.F6(o),c=new a.Jk(o);class s{static async createSubscription(e){try{let r={reason:`Suscripci\xf3n COMOD\xcdN IA - Plan ${e.planId}`,payer_email:e.email,back_url:e.backUrl,auto_recurring:{frequency:e.frequency,frequency_type:e.frequencyType,transaction_amount:e.amount,currency_id:e.currency,start_date:new Date().toISOString()},external_reference:e.organizationId,notification_url:e.notificationUrl,status:"pending"};return await i.create({body:r})}catch(e){throw console.error("Error creating MercadoPago subscription:",e),Error("Failed to create MercadoPago subscription")}}static async updateSubscription(e,r){try{let t={};return r.status&&(t.status=r.status),r.amount&&(t.auto_recurring={transaction_amount:r.amount}),await i.update({id:e,body:t})}catch(e){throw console.error("Error updating MercadoPago subscription:",e),Error("Failed to update MercadoPago subscription")}}static async cancelSubscription(e){try{return await i.update({id:e,body:{status:"cancelled"}})}catch(e){throw console.error("Error canceling MercadoPago subscription:",e),Error("Failed to cancel MercadoPago subscription")}}static async getSubscription(e){try{return await i.get({id:e})}catch(e){throw console.error("Error retrieving MercadoPago subscription:",e),Error("Failed to retrieve MercadoPago subscription")}}static async createPayment(e){try{let r={transaction_amount:e.amount,currency_id:e.currency,description:e.description,payer:{email:e.payerEmail},external_reference:e.externalReference,metadata:{organization_id:e.organizationId,source:"comodin_ia"}};return await n.create({body:r})}catch(e){throw console.error("Error creating MercadoPago payment:",e),Error("Failed to create MercadoPago payment")}}static async getPayment(e){try{return await n.get({id:e})}catch(e){throw console.error("Error retrieving MercadoPago payment:",e),Error("Failed to retrieve MercadoPago payment")}}static async createPreference(e){try{let r={items:[{id:`wallet_recharge_${e.organizationId}`,title:e.title,unit_price:e.price,quantity:1,currency_id:e.currency}],payer:{email:e.customerEmail},back_urls:{success:e.successUrl,failure:e.failureUrl,pending:e.pendingUrl},auto_return:"approved",external_reference:e.organizationId,statement_descriptor:"COMODIN IA",metadata:{organization_id:e.organizationId,type:"wallet_recharge",source:"comodin_ia",...e.metadata}},t=await c.create({body:r});return{preferenceId:t.id,initPoint:t.init_point}}catch(e){throw console.error("Error creating MercadoPago preference:",e),Error("Failed to create MercadoPago preference")}}static async processWebhookNotification(e){try{if("preapproval"===e.type){let r=e.data?.id||e.id,t=await this.getSubscription(r);return{type:"subscription",data:t}}if("payment"===e.type){let r=e.data?.id||e.id,t=await this.getPayment(r);return{type:"payment",data:t}}return null}catch(e){throw console.error("Error processing MercadoPago webhook notification:",e),Error("Failed to process MercadoPago webhook notification")}}}},19924:(e,r,t)=>{t.d(r,{t:()=>o});let a=new(t(33677)).Z(process.env.STRIPE_SECRET_KEY,{apiVersion:"2025-08-27.basil",typescript:!0});class o{static async createCustomer(e){try{return await a.customers.create({email:e.email,name:e.name,metadata:{organizationId:e.organizationId,source:"comodin_ia"}})}catch(e){throw console.error("Error creating Stripe customer:",e),Error("Failed to create Stripe customer")}}static async createSubscription(e){try{return await a.subscriptions.create({customer:e.customerId,items:[{price:e.priceId}],currency:e.currency,trial_period_days:e.trialPeriodDays,payment_behavior:"default_incomplete",payment_settings:{save_default_payment_method:"on_subscription"},expand:["latest_invoice.payment_intent"],metadata:{organizationId:e.organizationId,source:"comodin_ia"}})}catch(e){throw console.error("Error creating Stripe subscription:",e),Error("Failed to create Stripe subscription")}}static async updateSubscription(e,r){try{let t=await a.subscriptions.retrieve(e);return await a.subscriptions.update(e,{items:[{id:t.items.data[0].id,price:r}],proration_behavior:"create_prorations"})}catch(e){throw console.error("Error updating Stripe subscription:",e),Error("Failed to update Stripe subscription")}}static async cancelSubscription(e,r=!0){try{return await a.subscriptions.update(e,{cancel_at_period_end:r})}catch(e){throw console.error("Error canceling Stripe subscription:",e),Error("Failed to cancel Stripe subscription")}}static async getSubscription(e){try{return await a.subscriptions.retrieve(e,{expand:["latest_invoice","customer","items.data.price"]})}catch(e){throw console.error("Error retrieving Stripe subscription:",e),Error("Failed to retrieve Stripe subscription")}}static async createBillingPortalSession(e,r){try{return await a.billingPortal.sessions.create({customer:e,return_url:r})}catch(e){throw console.error("Error creating billing portal session:",e),Error("Failed to create billing portal session")}}static async createCheckoutSession(e){try{return await a.checkout.sessions.create({customer:e.customerId,customer_email:e.customerId?void 0:e.customerEmail,line_items:[{price:e.priceId,quantity:1}],mode:"subscription",success_url:e.successUrl,cancel_url:e.cancelUrl,subscription_data:{trial_period_days:e.trialPeriodDays,metadata:{organizationId:e.organizationId,source:"comodin_ia"}},metadata:{organizationId:e.organizationId,source:"comodin_ia"}})}catch(e){throw console.error("Error creating Stripe checkout session:",e),Error("Failed to create Stripe checkout session")}}static async createPaymentCheckoutSession(e){try{let r=await a.checkout.sessions.create({customer_email:e.customerEmail,line_items:[{price_data:{currency:e.currency.toLowerCase(),product_data:{name:e.description,description:`Recarga de billetera IA - ${e.organizationId}`},unit_amount:e.amount},quantity:1}],mode:"payment",success_url:e.successUrl,cancel_url:e.cancelUrl,metadata:{organizationId:e.organizationId,type:"wallet_recharge",amount:(e.amount/100).toString(),currency:e.currency,...e.metadata}});return{sessionId:r.id,sessionUrl:r.url}}catch(e){throw console.error("Error creating Stripe payment checkout session:",e),Error("Failed to create Stripe payment checkout session")}}static constructWebhookEvent(e,r){try{return a.webhooks.constructEvent(e,r,process.env.STRIPE_WEBHOOK_SECRET)}catch(e){throw console.error("Error constructing Stripe webhook event:",e),Error("Invalid Stripe webhook signature")}}}}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),a=r.X(0,[4372,7329,1472,7609,3677,9520,1826],()=>t(87905));module.exports=a})();