"use strict";(()=>{var e={};e.id=6886,e.ids=[6886],e.modules={53524:e=>{e.exports=require("@prisma/client")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},86624:e=>{e.exports=require("querystring")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},5909:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>h,patchFetch:()=>z,requestAsyncStorage:()=>R,routeModule:()=>y,serverHooks:()=>w,staticGenerationAsyncStorage:()=>f});var a={};r.r(a),r.d(a,{DELETE:()=>g,GET:()=>p,PATCH:()=>x,PUT:()=>m});var o=r(79182),s=r(72007),i=r(56719),n=r(93442),u=r(15649),d=r(53524),c=r(11826);let l=new d.PrismaClient;async function p(e,{params:t}){try{let e=await (0,u.getServerSession)(c.L);if(!e?.user?.organizationId)return n.NextResponse.json({error:"No autorizado"},{status:401});let r=await l.automationRule.findFirst({where:{id:t.id,organizationId:e.user.organizationId},include:{conditions:!0,actions:{orderBy:{executionOrder:"asc"}},executions:{take:10,orderBy:{createdAt:"desc"},include:{rule:{select:{name:!0}}}}}});if(!r)return n.NextResponse.json({success:!1,error:"Regla no encontrada"},{status:404});return n.NextResponse.json({success:!0,data:r})}catch(e){return console.error("Error obteniendo regla de automatizaci\xf3n:",e),n.NextResponse.json({success:!1,error:"Error interno del servidor"},{status:500})}}async function m(e,{params:t}){try{let r=await (0,u.getServerSession)(c.L);if(!r?.user?.organizationId||!r?.user?.id)return n.NextResponse.json({error:"No autorizado"},{status:401});if("PROPIETARIO"!==r.user.role)return n.NextResponse.json({error:"Solo el propietario puede modificar reglas de automatizaci\xf3n"},{status:403});let a=await e.json();if(!await l.automationRule.findFirst({where:{id:t.id,organizationId:r.user.organizationId}}))return n.NextResponse.json({success:!1,error:"Regla no encontrada"},{status:404});let o=await l.$transaction(async e=>(a.conditions&&await e.automationCondition.deleteMany({where:{ruleId:t.id}}),a.actions&&await e.automationAction.deleteMany({where:{ruleId:t.id}}),await e.automationRule.update({where:{id:t.id},data:{name:a.name?.trim(),description:a.description?.trim(),priority:a.priority,isActive:a.isActive,modifiedBy:r.user.id,modifiedByName:r.user.name||r.user.email||"Usuario",...a.conditions&&{conditions:{create:a.conditions.map(e=>({type:e.type,logicalOperator:e.logicalOperator||"AND",intentionTypes:e.intentionTypes||[],keywords:e.keywords||[],keywordMatchType:e.keywordMatchType,timeStart:e.timeStart,timeEnd:e.timeEnd,weekdays:e.weekdays||[],timezone:e.timezone,messageCountMin:e.messageCountMin,messageCountMax:e.messageCountMax,responseTimeMin:e.responseTimeMin,responseTimeMax:e.responseTimeMax,metadata:e.metadata}))}},...a.actions&&{actions:{create:a.actions.map((e,t)=>({type:e.type,executionOrder:e.executionOrder||t+1,tagName:e.tagName,tagColor:e.tagColor,agentId:e.agentId,priority:e.priority,replyMessage:e.replyMessage,replyDelay:e.replyDelay,targetAgentId:e.targetAgentId,transferReason:e.transferReason,taskTitle:e.taskTitle,taskDescription:e.taskDescription,taskDueDate:e.taskDueDate,notificationTitle:e.notificationTitle,notificationMessage:e.notificationMessage,notificationChannels:e.notificationChannels||[],metadata:e.metadata}))}}},include:{conditions:!0,actions:!0}})));return n.NextResponse.json({success:!0,data:o,message:"Regla actualizada exitosamente"})}catch(e){return console.error("Error actualizando regla de automatizaci\xf3n:",e),n.NextResponse.json({success:!1,error:"Error interno del servidor"},{status:500})}}async function g(e,{params:t}){try{let e=await (0,u.getServerSession)(c.L);if(!e?.user?.organizationId)return n.NextResponse.json({error:"No autorizado"},{status:401});if("PROPIETARIO"!==e.user.role)return n.NextResponse.json({error:"Solo el propietario puede eliminar reglas de automatizaci\xf3n"},{status:403});if(!await l.automationRule.findFirst({where:{id:t.id,organizationId:e.user.organizationId}}))return n.NextResponse.json({success:!1,error:"Regla no encontrada"},{status:404});return await l.automationRule.delete({where:{id:t.id}}),n.NextResponse.json({success:!0,message:"Regla eliminada exitosamente"})}catch(e){return console.error("Error eliminando regla de automatizaci\xf3n:",e),n.NextResponse.json({success:!1,error:"Error interno del servidor"},{status:500})}}async function x(e,{params:t}){try{let r=await (0,u.getServerSession)(c.L);if(!r?.user?.organizationId)return n.NextResponse.json({error:"No autorizado"},{status:401});if("PROPIETARIO"!==r.user.role)return n.NextResponse.json({error:"Solo el propietario puede modificar reglas de automatizaci\xf3n"},{status:403});let{isActive:a}=await e.json();if(!await l.automationRule.findFirst({where:{id:t.id,organizationId:r.user.organizationId}}))return n.NextResponse.json({success:!1,error:"Regla no encontrada"},{status:404});let o=await l.automationRule.update({where:{id:t.id},data:{isActive:a,modifiedBy:r.user.id,modifiedByName:r.user.name||r.user.email||"Usuario"}});return n.NextResponse.json({success:!0,data:o,message:`Regla ${a?"activada":"desactivada"} exitosamente`})}catch(e){return console.error("Error actualizando estado de regla:",e),n.NextResponse.json({success:!1,error:"Error interno del servidor"},{status:500})}}let y=new o.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/automations/rules/[id]/route",pathname:"/api/automations/rules/[id]",filename:"route",bundlePath:"app/api/automations/rules/[id]/route"},resolvedPagePath:"/home/ubuntu/comodin_ia/app/app/api/automations/rules/[id]/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:R,staticGenerationAsyncStorage:f,serverHooks:w}=y,h="/api/automations/rules/[id]/route";function z(){return(0,i.patchFetch)({serverHooks:w,staticGenerationAsyncStorage:f})}}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[4372,7329,1472,7609,1826],()=>r(5909));module.exports=a})();