"use strict";(()=>{var e={};e.id=5873,e.ids=[5873],e.modules={21841:e=>{e.exports=require("@aws-sdk/client-s3")},53524:e=>{e.exports=require("@prisma/client")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},92048:e=>{e.exports=require("fs")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},19801:e=>{e.exports=require("os")},55315:e=>{e.exports=require("path")},86624:e=>{e.exports=require("querystring")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},25508:(e,r,t)=>{t.r(r),t.d(r,{originalPathname:()=>q,patchFetch:()=>f,requestAsyncStorage:()=>x,routeModule:()=>m,serverHooks:()=>h,staticGenerationAsyncStorage:()=>g});var s={};t.r(s),t.d(s,{GET:()=>d,POST:()=>l});var o=t(79182),n=t(72007),i=t(56719),a=t(93442),u=t(15649),p=t(11826),c=t(25522);async function l(e){try{let r=await (0,u.getServerSession)(p.L);if(!r?.user)return a.NextResponse.json({error:"No autorizado"},{status:401});let{query:t,conversationId:s="test-conversation",options:o={}}=await e.json(),n=r.user.organizationId,i=r.user.id,l=r.user.name;if(!t||0===t.trim().length)return a.NextResponse.json({error:"Query requerido para la prueba"},{status:400});console.log("\uD83E\uDDEA Probando resoluci\xf3n de IA para:",t);let d=await (0,c.ZR)(n,i,l,t,s,{maxResults:5,minSimilarity:.7,includeFilesInResponse:!0,responseStyle:"professional",...o});return a.NextResponse.json({success:!0,data:{query:t,resolution:d,summary:{hasResponse:d.responseText.length>0,confidence:d.confidence,knowledgeSourcesFound:d.knowledgeUsed.length,filesWouldBeSent:d.filesToSend.length,processingTimeMs:d.processingTime,wouldAutoRespond:d.confidence>=.7}}})}catch(e){return console.error("Error en prueba de resoluci\xf3n:",e),a.NextResponse.json({error:"Error interno del servidor"},{status:500})}}async function d(e){try{let e=await (0,u.getServerSession)(p.L);if(!e?.user)return a.NextResponse.json({error:"No autorizado"},{status:401});let r=e.user.organizationId,{PrismaClient:s}=t(53524),o=new s,n=await o.knowledgeUsage.findMany({where:{organizationId:r,queryType:"ai_resolution",createdAt:{gte:new Date(Date.now()-6048e5)}},orderBy:{createdAt:"desc"},take:50}),i={totalResolutions:n.length,avgConfidence:n.length>0?n.reduce((e,r)=>e+(r.avgSimilarity?.toNumber()||0),0)/n.length:0,responseGenerated:n.filter(e=>e.responseGenerated).length,avgProcessingTime:n.length>0?n.reduce((e,r)=>e+r.processingTime,0)/n.length:0,sourcesUsed:new Set(n.flatMap(e=>e.sourcesConsulted||[])).size,fileAttachments:n.reduce((e,r)=>{let t=r.metadata;return e+(t?.filesAttached||0)},0)};return a.NextResponse.json({success:!0,data:{period:"\xdaltimos 7 d\xedas",statistics:i,recentQueries:n.slice(0,10).map(e=>({query:e.query,confidence:e.avgSimilarity?.toNumber()||0,sourcesUsed:e.sourcesConsulted?.length||0,responseGenerated:e.responseGenerated,timestamp:e.createdAt}))}})}catch(e){return console.error("Error obteniendo estad\xedsticas:",e),a.NextResponse.json({error:"Error interno del servidor"},{status:500})}}let m=new o.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/crm/ai-resolution/test/route",pathname:"/api/crm/ai-resolution/test",filename:"route",bundlePath:"app/api/crm/ai-resolution/test/route"},resolvedPagePath:"/home/ubuntu/comodin_ia/app/app/api/crm/ai-resolution/test/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:x,staticGenerationAsyncStorage:g,serverHooks:h}=m,q="/api/crm/ai-resolution/test/route";function f(){return(0,i.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:g})}}};var r=require("../../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),s=r.X(0,[4372,7329,1472,7609,2770,8872,1826,6780,1940],()=>t(25508));module.exports=s})();