"use strict";(()=>{var e={};e.id=867,e.ids=[867],e.modules={53524:e=>{e.exports=require("@prisma/client")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},86624:e=>{e.exports=require("querystring")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},20221:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>v,patchFetch:()=>I,requestAsyncStorage:()=>y,routeModule:()=>g,serverHooks:()=>h,staticGenerationAsyncStorage:()=>x});var n={};r.r(n),r.d(n,{GET:()=>m,POST:()=>l});var a=r(79182),s=r(72007),o=r(56719),i=r(93442),c=r(15649),d=r(53524),u=r(11826);let p=new d.PrismaClient;async function m(e){try{let t=await (0,c.getServerSession)(u.L);if(!t?.user?.organizationId)return i.NextResponse.json({error:"No autorizado"},{status:401});let{searchParams:r}=new URL(e.url),n=r.get("conversationId"),a=parseInt(r.get("page")||"1"),s=Math.min(parseInt(r.get("limit")||"50"),100);if(!n)return i.NextResponse.json({success:!1,error:"ID de conversaci\xf3n requerido"},{status:400});let o=(a-1)*s;if(!await p.conversation.findFirst({where:{id:n,organizationId:t.user.organizationId}}))return i.NextResponse.json({success:!1,error:"Conversaci\xf3n no encontrada"},{status:404});let[d,m]=await Promise.all([p.message.findMany({where:{conversationId:n,organizationId:t.user.organizationId},orderBy:{sentAt:"asc"},skip:o,take:s,include:{replyTo:{select:{id:!0,content:!0,sentByName:!0}}}}),p.message.count({where:{conversationId:n,organizationId:t.user.organizationId}})]);return await p.message.updateMany({where:{conversationId:n,direction:"INCOMING",isRead:!1},data:{isRead:!0,readAt:new Date}}),await p.conversation.update({where:{id:n},data:{unreadCount:0}}),i.NextResponse.json({success:!0,data:d.map(e=>({id:e.id,conversationId:e.conversationId,direction:e.direction,type:e.type,content:e.content,attachmentUrl:e.attachmentUrl,attachmentType:e.attachmentType,attachmentName:e.attachmentName,sentBy:e.sentBy,sentByName:e.sentByName,isRead:e.isRead,readAt:e.readAt,sentAt:e.sentAt,replyTo:e.replyTo})),pagination:{page:a,limit:s,total:m,totalPages:Math.ceil(m/s)}})}catch(e){return console.error("Error obteniendo mensajes:",e),i.NextResponse.json({success:!1,error:"Error interno del servidor"},{status:500})}}async function l(e){try{let t=await (0,c.getServerSession)(u.L);if(!t?.user?.organizationId||!t?.user?.id)return i.NextResponse.json({error:"No autorizado"},{status:401});let r=await e.json();if(!r.conversationId||!r.content?.trim())return i.NextResponse.json({success:!1,error:"ID de conversaci\xf3n y contenido son requeridos"},{status:400});if(!await p.conversation.findFirst({where:{id:r.conversationId,organizationId:t.user.organizationId},include:{contact:!0}}))return i.NextResponse.json({success:!1,error:"Conversaci\xf3n no encontrada"},{status:404});let n=await p.message.create({data:{organizationId:t.user.organizationId,conversationId:r.conversationId,direction:"OUTGOING",type:r.type||"TEXT",content:r.content.trim(),attachmentUrl:r.attachmentUrl,attachmentType:r.attachmentType,attachmentName:r.attachmentName,sentBy:t.user.id,sentByName:t.user.name||t.user.email||"Usuario",replyToId:r.replyToId,sentAt:new Date},include:{replyTo:{select:{id:!0,content:!0,sentByName:!0}}}});return await p.conversation.update({where:{id:r.conversationId},data:{lastMessageAt:new Date,lastMessageText:r.content.trim().substring(0,100),lastMessageFrom:"OUTGOING",messageCount:{increment:1}}}),i.NextResponse.json({success:!0,data:{id:n.id,conversationId:n.conversationId,direction:n.direction,type:n.type,content:n.content,attachmentUrl:n.attachmentUrl,attachmentType:n.attachmentType,attachmentName:n.attachmentName,sentBy:n.sentBy,sentByName:n.sentByName,isRead:n.isRead,readAt:n.readAt,sentAt:n.sentAt,replyTo:n.replyTo},message:"Mensaje enviado exitosamente"})}catch(e){return console.error("Error enviando mensaje:",e),i.NextResponse.json({success:!1,error:"Error interno del servidor"},{status:500})}}let g=new a.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/crm/messages/route",pathname:"/api/crm/messages",filename:"route",bundlePath:"app/api/crm/messages/route"},resolvedPagePath:"/home/ubuntu/comodin_ia/app/app/api/crm/messages/route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:y,staticGenerationAsyncStorage:x,serverHooks:h}=g,v="/api/crm/messages/route";function I(){return(0,o.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:x})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[4372,7329,1472,7609,1826],()=>r(20221));module.exports=n})();