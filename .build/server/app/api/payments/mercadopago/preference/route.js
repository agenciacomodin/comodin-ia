"use strict";(()=>{var e={};e.id=5913,e.ids=[5913],e.modules={53524:e=>{e.exports=require("@prisma/client")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},68621:e=>{e.exports=require("punycode")},86624:e=>{e.exports=require("querystring")},76162:e=>{e.exports=require("stream")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},1579:(e,r,a)=>{a.r(r),a.d(r,{originalPathname:()=>f,patchFetch:()=>P,requestAsyncStorage:()=>g,routeModule:()=>y,serverHooks:()=>h,staticGenerationAsyncStorage:()=>x});var t={};a.r(t),a.d(t,{POST:()=>m});var n=a(79182),o=a(72007),s=a(56719),i=a(93442),c=a(57978),u=a(11826),p=a(20591),d=a(17439),l=a(53524);async function m(e){try{let r=await (0,c.getServerSession)(u.L);if(!r?.user?.organizationId)return i.NextResponse.json({error:"Unauthorized"},{status:401});let{plan:a,billingCycle:t="monthly",currency:n="ARS"}=await e.json();if(!a||!Object.values(l.SubscriptionPlan).includes(a))return i.NextResponse.json({error:"Invalid or missing plan"},{status:400});(0,d.lh)(a);let o=(0,d.oW)(a,n.toLowerCase(),t);if(0===o)return i.NextResponse.json({error:"Free plan cannot be purchased"},{status:400});let s=process.env.NEXTAUTH_URL||"http://localhost:3000",m=`${s}/dashboard`,y=`${s}/api/webhooks/mercadopago`,g=await p.M.createSubscription({email:r.user.email,organizationId:r.user.organizationId,planId:a,amount:o,currency:n,frequency:"yearly"===t?12:1,frequencyType:"months",backUrl:m,notificationUrl:y});return i.NextResponse.json({preapprovalUrl:g.init_point,preapprovalId:g.id})}catch(e){return console.error("Error creating MercadoPago preference:",e),i.NextResponse.json({error:"Failed to create payment preference"},{status:500})}}let y=new n.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/payments/mercadopago/preference/route",pathname:"/api/payments/mercadopago/preference",filename:"route",bundlePath:"app/api/payments/mercadopago/preference/route"},resolvedPagePath:"/home/ubuntu/comodin_ia/app/app/api/payments/mercadopago/preference/route.ts",nextConfigOutput:"",userland:t}),{requestAsyncStorage:g,staticGenerationAsyncStorage:x,serverHooks:h}=y,f="/api/payments/mercadopago/preference/route";function P(){return(0,s.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:x})}},20591:(e,r,a)=>{a.d(r,{M:()=>c});var t=a(79520);let n=new t.f7({accessToken:process.env.MERCADO_PAGO_ACCESS_TOKEN,options:{timeout:5e3}}),o=new t.kX(n),s=new t.F6(n),i=new t.Jk(n);class c{static async createSubscription(e){try{let r={reason:`Suscripci\xf3n COMOD\xcdN IA - Plan ${e.planId}`,payer_email:e.email,back_url:e.backUrl,auto_recurring:{frequency:e.frequency,frequency_type:e.frequencyType,transaction_amount:e.amount,currency_id:e.currency,start_date:new Date().toISOString()},external_reference:e.organizationId,notification_url:e.notificationUrl,status:"pending"};return await o.create({body:r})}catch(e){throw console.error("Error creating MercadoPago subscription:",e),Error("Failed to create MercadoPago subscription")}}static async updateSubscription(e,r){try{let a={};return r.status&&(a.status=r.status),r.amount&&(a.auto_recurring={transaction_amount:r.amount}),await o.update({id:e,body:a})}catch(e){throw console.error("Error updating MercadoPago subscription:",e),Error("Failed to update MercadoPago subscription")}}static async cancelSubscription(e){try{return await o.update({id:e,body:{status:"cancelled"}})}catch(e){throw console.error("Error canceling MercadoPago subscription:",e),Error("Failed to cancel MercadoPago subscription")}}static async getSubscription(e){try{return await o.get({id:e})}catch(e){throw console.error("Error retrieving MercadoPago subscription:",e),Error("Failed to retrieve MercadoPago subscription")}}static async createPayment(e){try{let r={transaction_amount:e.amount,currency_id:e.currency,description:e.description,payer:{email:e.payerEmail},external_reference:e.externalReference,metadata:{organization_id:e.organizationId,source:"comodin_ia"}};return await s.create({body:r})}catch(e){throw console.error("Error creating MercadoPago payment:",e),Error("Failed to create MercadoPago payment")}}static async getPayment(e){try{return await s.get({id:e})}catch(e){throw console.error("Error retrieving MercadoPago payment:",e),Error("Failed to retrieve MercadoPago payment")}}static async createPreference(e){try{let r={items:[{id:`wallet_recharge_${e.organizationId}`,title:e.title,unit_price:e.price,quantity:1,currency_id:e.currency}],payer:{email:e.customerEmail},back_urls:{success:e.successUrl,failure:e.failureUrl,pending:e.pendingUrl},auto_return:"approved",external_reference:e.organizationId,statement_descriptor:"COMODIN IA",metadata:{organization_id:e.organizationId,type:"wallet_recharge",source:"comodin_ia",...e.metadata}},a=await i.create({body:r});return{preferenceId:a.id,initPoint:a.init_point}}catch(e){throw console.error("Error creating MercadoPago preference:",e),Error("Failed to create MercadoPago preference")}}static async processWebhookNotification(e){try{if("preapproval"===e.type){let r=e.data?.id||e.id,a=await this.getSubscription(r);return{type:"subscription",data:a}}if("payment"===e.type){let r=e.data?.id||e.id,a=await this.getPayment(r);return{type:"payment",data:a}}return null}catch(e){throw console.error("Error processing MercadoPago webhook notification:",e),Error("Failed to process MercadoPago webhook notification")}}}},17439:(e,r,a)=>{a.d(r,{lh:()=>o,oW:()=>i,ys:()=>s});var t=a(53524);let n={[t.SubscriptionPlan.FREE]:{id:t.SubscriptionPlan.FREE,name:"Gratuito",description:"Para probar COMOD\xcdN IA y comenzar a organizar tus comunicaciones",features:{maxUsers:1,maxMessages:100,maxIntegrations:1,hasAdvancedFeatures:!1,hasAnalytics:!1,hasAutomation:!1,hasAPIAccess:!1,supportLevel:"community"},pricing:{monthly:{usd:0,mxn:0,ars:0},yearly:{usd:0,mxn:0,ars:0}}},[t.SubscriptionPlan.STARTER]:{id:t.SubscriptionPlan.STARTER,name:"Emprendedor",description:"Perfecto para peque\xf1os negocios que est\xe1n comenzando",features:{maxUsers:3,maxMessages:1e3,maxIntegrations:3,hasAdvancedFeatures:!0,hasAnalytics:!0,hasAutomation:!1,hasAPIAccess:!1,supportLevel:"email"},pricing:{monthly:{usd:29,mxn:499,ars:8900},yearly:{usd:290,mxn:4990,ars:89e3}},popular:!0},[t.SubscriptionPlan.PREMIUM]:{id:t.SubscriptionPlan.PREMIUM,name:"Profesional",description:"Para equipos que necesitan funcionalidades avanzadas y automatizaci\xf3n",features:{maxUsers:10,maxMessages:5e3,maxIntegrations:10,hasAdvancedFeatures:!0,hasAnalytics:!0,hasAutomation:!0,hasAPIAccess:!0,supportLevel:"priority"},pricing:{monthly:{usd:79,mxn:1399,ars:24900},yearly:{usd:790,mxn:13990,ars:249e3}}},[t.SubscriptionPlan.ENTERPRISE]:{id:t.SubscriptionPlan.ENTERPRISE,name:"Empresarial",description:"Para organizaciones grandes con necesidades espec\xedficas y soporte dedicado",features:{maxUsers:50,maxMessages:2e4,maxIntegrations:50,hasAdvancedFeatures:!0,hasAnalytics:!0,hasAutomation:!0,hasAPIAccess:!0,supportLevel:"dedicated"},pricing:{monthly:{usd:199,mxn:3499,ars:62900},yearly:{usd:1990,mxn:34990,ars:629e3}}}};function o(e){return n[e]}function s(e,r,a,t){let o=n[e];return{usersExceeded:r>o.features.maxUsers,messagesExceeded:a>o.features.maxMessages,integrationsExceeded:t>o.features.maxIntegrations}}function i(e,r,a){return n[e].pricing[a][r]}}};var r=require("../../../../../webpack-runtime.js");r.C(e);var a=e=>r(r.s=e),t=r.X(0,[4372,7329,1472,7609,9520,1826],()=>a(1579));module.exports=t})();