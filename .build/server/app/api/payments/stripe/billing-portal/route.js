"use strict";(()=>{var e={};e.id=2657,e.ids=[2657],e.modules={53524:e=>{e.exports=require("@prisma/client")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},78893:e=>{e.exports=require("buffer")},61282:e=>{e.exports=require("child_process")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},86624:e=>{e.exports=require("querystring")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},80501:(e,r,t)=>{t.r(r),t.d(r,{originalPathname:()=>b,patchFetch:()=>_,requestAsyncStorage:()=>g,routeModule:()=>m,serverHooks:()=>h,staticGenerationAsyncStorage:()=>y});var i={};t.r(i),t.d(i,{POST:()=>d});var o=t(79182),s=t(72007),a=t(56719),n=t(93442),c=t(57978),u=t(11826),p=t(19924),l=t(83178);async function d(e){try{let e=await (0,c.getServerSession)(u.L);if(!e?.user?.organizationId)return n.NextResponse.json({error:"Unauthorized"},{status:401});let r=await l.db.subscription.findFirst({where:{organizationId:e.user.organizationId,paymentProvider:"STRIPE",stripeCustomerId:{not:null}}});if(!r?.stripeCustomerId)return n.NextResponse.json({error:"No Stripe customer found"},{status:404});let t=process.env.NEXTAUTH_URL||"http://localhost:3000",i=`${t}/dashboard`,o=await p.t.createBillingPortalSession(r.stripeCustomerId,i);return n.NextResponse.json({portalUrl:o.url})}catch(e){return console.error("Error creating billing portal session:",e),n.NextResponse.json({error:"Failed to create billing portal session"},{status:500})}}let m=new o.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/payments/stripe/billing-portal/route",pathname:"/api/payments/stripe/billing-portal",filename:"route",bundlePath:"app/api/payments/stripe/billing-portal/route"},resolvedPagePath:"/home/ubuntu/comodin_ia/app/app/api/payments/stripe/billing-portal/route.ts",nextConfigOutput:"",userland:i}),{requestAsyncStorage:g,staticGenerationAsyncStorage:y,serverHooks:h}=m,b="/api/payments/stripe/billing-portal/route";function _(){return(0,a.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:y})}},19924:(e,r,t)=>{t.d(r,{t:()=>o});let i=new(t(33677)).Z(process.env.STRIPE_SECRET_KEY,{apiVersion:"2025-08-27.basil",typescript:!0});class o{static async createCustomer(e){try{return await i.customers.create({email:e.email,name:e.name,metadata:{organizationId:e.organizationId,source:"comodin_ia"}})}catch(e){throw console.error("Error creating Stripe customer:",e),Error("Failed to create Stripe customer")}}static async createSubscription(e){try{return await i.subscriptions.create({customer:e.customerId,items:[{price:e.priceId}],currency:e.currency,trial_period_days:e.trialPeriodDays,payment_behavior:"default_incomplete",payment_settings:{save_default_payment_method:"on_subscription"},expand:["latest_invoice.payment_intent"],metadata:{organizationId:e.organizationId,source:"comodin_ia"}})}catch(e){throw console.error("Error creating Stripe subscription:",e),Error("Failed to create Stripe subscription")}}static async updateSubscription(e,r){try{let t=await i.subscriptions.retrieve(e);return await i.subscriptions.update(e,{items:[{id:t.items.data[0].id,price:r}],proration_behavior:"create_prorations"})}catch(e){throw console.error("Error updating Stripe subscription:",e),Error("Failed to update Stripe subscription")}}static async cancelSubscription(e,r=!0){try{return await i.subscriptions.update(e,{cancel_at_period_end:r})}catch(e){throw console.error("Error canceling Stripe subscription:",e),Error("Failed to cancel Stripe subscription")}}static async getSubscription(e){try{return await i.subscriptions.retrieve(e,{expand:["latest_invoice","customer","items.data.price"]})}catch(e){throw console.error("Error retrieving Stripe subscription:",e),Error("Failed to retrieve Stripe subscription")}}static async createBillingPortalSession(e,r){try{return await i.billingPortal.sessions.create({customer:e,return_url:r})}catch(e){throw console.error("Error creating billing portal session:",e),Error("Failed to create billing portal session")}}static async createCheckoutSession(e){try{return await i.checkout.sessions.create({customer:e.customerId,customer_email:e.customerId?void 0:e.customerEmail,line_items:[{price:e.priceId,quantity:1}],mode:"subscription",success_url:e.successUrl,cancel_url:e.cancelUrl,subscription_data:{trial_period_days:e.trialPeriodDays,metadata:{organizationId:e.organizationId,source:"comodin_ia"}},metadata:{organizationId:e.organizationId,source:"comodin_ia"}})}catch(e){throw console.error("Error creating Stripe checkout session:",e),Error("Failed to create Stripe checkout session")}}static async createPaymentCheckoutSession(e){try{let r=await i.checkout.sessions.create({customer_email:e.customerEmail,line_items:[{price_data:{currency:e.currency.toLowerCase(),product_data:{name:e.description,description:`Recarga de billetera IA - ${e.organizationId}`},unit_amount:e.amount},quantity:1}],mode:"payment",success_url:e.successUrl,cancel_url:e.cancelUrl,metadata:{organizationId:e.organizationId,type:"wallet_recharge",amount:(e.amount/100).toString(),currency:e.currency,...e.metadata}});return{sessionId:r.id,sessionUrl:r.url}}catch(e){throw console.error("Error creating Stripe payment checkout session:",e),Error("Failed to create Stripe payment checkout session")}}static constructWebhookEvent(e,r){try{return i.webhooks.constructEvent(e,r,process.env.STRIPE_WEBHOOK_SECRET)}catch(e){throw console.error("Error constructing Stripe webhook event:",e),Error("Invalid Stripe webhook signature")}}}}};var r=require("../../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),i=r.X(0,[4372,7329,1472,7609,3677,1826],()=>t(80501));module.exports=i})();