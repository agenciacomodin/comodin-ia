"use strict";(()=>{var e={};e.id=9099,e.ids=[9099],e.modules={53524:e=>{e.exports=require("@prisma/client")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},78893:e=>{e.exports=require("buffer")},61282:e=>{e.exports=require("child_process")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},86624:e=>{e.exports=require("querystring")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},53324:(e,r,t)=>{t.r(r),t.d(r,{originalPathname:()=>E,patchFetch:()=>b,requestAsyncStorage:()=>y,routeModule:()=>h,serverHooks:()=>x,staticGenerationAsyncStorage:()=>g});var s={};t.r(s),t.d(s,{POST:()=>m});var a=t(79182),i=t(72007),o=t(56719),n=t(93442),c=t(57978),u=t(11826),p=t(19924),d=t(17439),l=t(53524);async function m(e){try{let r=await (0,c.getServerSession)(u.L);if(!r?.user?.organizationId)return n.NextResponse.json({error:"Unauthorized"},{status:401});let{plan:t,billingCycle:s="monthly",trialDays:a=7}=await e.json();if(!t||!Object.values(l.SubscriptionPlan).includes(t))return n.NextResponse.json({error:"Invalid or missing plan"},{status:400});(0,d.lh)(t);let i=`price_${t.toLowerCase()}_${s}`,o=process.env.NEXTAUTH_URL||"http://localhost:3000",m=`${o}/dashboard?subscription=success`,h=`${o}/dashboard?subscription=cancelled`,y=await p.t.createCheckoutSession({priceId:i,successUrl:m,cancelUrl:h,organizationId:r.user.organizationId,customerEmail:r.user.email,trialPeriodDays:a});return n.NextResponse.json({checkoutUrl:y.url,sessionId:y.id})}catch(e){return console.error("Error creating Stripe checkout session:",e),n.NextResponse.json({error:"Failed to create checkout session"},{status:500})}}let h=new a.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/payments/stripe/checkout/route",pathname:"/api/payments/stripe/checkout",filename:"route",bundlePath:"app/api/payments/stripe/checkout/route"},resolvedPagePath:"/home/ubuntu/comodin_ia/app/app/api/payments/stripe/checkout/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:y,staticGenerationAsyncStorage:g,serverHooks:x}=h,E="/api/payments/stripe/checkout/route";function b(){return(0,o.patchFetch)({serverHooks:x,staticGenerationAsyncStorage:g})}},19924:(e,r,t)=>{t.d(r,{t:()=>a});let s=new(t(33677)).Z(process.env.STRIPE_SECRET_KEY,{apiVersion:"2025-08-27.basil",typescript:!0});class a{static async createCustomer(e){try{return await s.customers.create({email:e.email,name:e.name,metadata:{organizationId:e.organizationId,source:"comodin_ia"}})}catch(e){throw console.error("Error creating Stripe customer:",e),Error("Failed to create Stripe customer")}}static async createSubscription(e){try{return await s.subscriptions.create({customer:e.customerId,items:[{price:e.priceId}],currency:e.currency,trial_period_days:e.trialPeriodDays,payment_behavior:"default_incomplete",payment_settings:{save_default_payment_method:"on_subscription"},expand:["latest_invoice.payment_intent"],metadata:{organizationId:e.organizationId,source:"comodin_ia"}})}catch(e){throw console.error("Error creating Stripe subscription:",e),Error("Failed to create Stripe subscription")}}static async updateSubscription(e,r){try{let t=await s.subscriptions.retrieve(e);return await s.subscriptions.update(e,{items:[{id:t.items.data[0].id,price:r}],proration_behavior:"create_prorations"})}catch(e){throw console.error("Error updating Stripe subscription:",e),Error("Failed to update Stripe subscription")}}static async cancelSubscription(e,r=!0){try{return await s.subscriptions.update(e,{cancel_at_period_end:r})}catch(e){throw console.error("Error canceling Stripe subscription:",e),Error("Failed to cancel Stripe subscription")}}static async getSubscription(e){try{return await s.subscriptions.retrieve(e,{expand:["latest_invoice","customer","items.data.price"]})}catch(e){throw console.error("Error retrieving Stripe subscription:",e),Error("Failed to retrieve Stripe subscription")}}static async createBillingPortalSession(e,r){try{return await s.billingPortal.sessions.create({customer:e,return_url:r})}catch(e){throw console.error("Error creating billing portal session:",e),Error("Failed to create billing portal session")}}static async createCheckoutSession(e){try{return await s.checkout.sessions.create({customer:e.customerId,customer_email:e.customerId?void 0:e.customerEmail,line_items:[{price:e.priceId,quantity:1}],mode:"subscription",success_url:e.successUrl,cancel_url:e.cancelUrl,subscription_data:{trial_period_days:e.trialPeriodDays,metadata:{organizationId:e.organizationId,source:"comodin_ia"}},metadata:{organizationId:e.organizationId,source:"comodin_ia"}})}catch(e){throw console.error("Error creating Stripe checkout session:",e),Error("Failed to create Stripe checkout session")}}static async createPaymentCheckoutSession(e){try{let r=await s.checkout.sessions.create({customer_email:e.customerEmail,line_items:[{price_data:{currency:e.currency.toLowerCase(),product_data:{name:e.description,description:`Recarga de billetera IA - ${e.organizationId}`},unit_amount:e.amount},quantity:1}],mode:"payment",success_url:e.successUrl,cancel_url:e.cancelUrl,metadata:{organizationId:e.organizationId,type:"wallet_recharge",amount:(e.amount/100).toString(),currency:e.currency,...e.metadata}});return{sessionId:r.id,sessionUrl:r.url}}catch(e){throw console.error("Error creating Stripe payment checkout session:",e),Error("Failed to create Stripe payment checkout session")}}static constructWebhookEvent(e,r){try{return s.webhooks.constructEvent(e,r,process.env.STRIPE_WEBHOOK_SECRET)}catch(e){throw console.error("Error constructing Stripe webhook event:",e),Error("Invalid Stripe webhook signature")}}}},17439:(e,r,t)=>{t.d(r,{lh:()=>i,oW:()=>n,ys:()=>o});var s=t(53524);let a={[s.SubscriptionPlan.FREE]:{id:s.SubscriptionPlan.FREE,name:"Gratuito",description:"Para probar COMOD\xcdN IA y comenzar a organizar tus comunicaciones",features:{maxUsers:1,maxMessages:100,maxIntegrations:1,hasAdvancedFeatures:!1,hasAnalytics:!1,hasAutomation:!1,hasAPIAccess:!1,supportLevel:"community"},pricing:{monthly:{usd:0,mxn:0,ars:0},yearly:{usd:0,mxn:0,ars:0}}},[s.SubscriptionPlan.STARTER]:{id:s.SubscriptionPlan.STARTER,name:"Emprendedor",description:"Perfecto para peque\xf1os negocios que est\xe1n comenzando",features:{maxUsers:3,maxMessages:1e3,maxIntegrations:3,hasAdvancedFeatures:!0,hasAnalytics:!0,hasAutomation:!1,hasAPIAccess:!1,supportLevel:"email"},pricing:{monthly:{usd:29,mxn:499,ars:8900},yearly:{usd:290,mxn:4990,ars:89e3}},popular:!0},[s.SubscriptionPlan.PREMIUM]:{id:s.SubscriptionPlan.PREMIUM,name:"Profesional",description:"Para equipos que necesitan funcionalidades avanzadas y automatizaci\xf3n",features:{maxUsers:10,maxMessages:5e3,maxIntegrations:10,hasAdvancedFeatures:!0,hasAnalytics:!0,hasAutomation:!0,hasAPIAccess:!0,supportLevel:"priority"},pricing:{monthly:{usd:79,mxn:1399,ars:24900},yearly:{usd:790,mxn:13990,ars:249e3}}},[s.SubscriptionPlan.ENTERPRISE]:{id:s.SubscriptionPlan.ENTERPRISE,name:"Empresarial",description:"Para organizaciones grandes con necesidades espec\xedficas y soporte dedicado",features:{maxUsers:50,maxMessages:2e4,maxIntegrations:50,hasAdvancedFeatures:!0,hasAnalytics:!0,hasAutomation:!0,hasAPIAccess:!0,supportLevel:"dedicated"},pricing:{monthly:{usd:199,mxn:3499,ars:62900},yearly:{usd:1990,mxn:34990,ars:629e3}}}};function i(e){return a[e]}function o(e,r,t,s){let i=a[e];return{usersExceeded:r>i.features.maxUsers,messagesExceeded:t>i.features.maxMessages,integrationsExceeded:s>i.features.maxIntegrations}}function n(e,r,t){return a[e].pricing[t][r]}}};var r=require("../../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),s=r.X(0,[4372,7329,1472,7609,3677,1826],()=>t(53324));module.exports=s})();