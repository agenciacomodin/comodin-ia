"use strict";(()=>{var e={};e.id=5655,e.ids=[5655],e.modules={53524:e=>{e.exports=require("@prisma/client")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},86624:e=>{e.exports=require("querystring")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},89364:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>y,patchFetch:()=>q,requestAsyncStorage:()=>h,routeModule:()=>w,serverHooks:()=>D,staticGenerationAsyncStorage:()=>x});var a={};r.r(a),r.d(a,{GET:()=>l});var s=r(79182),n=r(72007),o=r(56719),i=r(93442),u=r(57978),p=r(11826),c=r(83178);async function l(e){try{let e=await (0,u.getServerSession)(p.L);if(!e||"SUPER_ADMIN"!==e.user.role)return i.NextResponse.json({error:"Unauthorized"},{status:401});let t=new Date;t.setDate(t.getDate()-30);let r=new Date;r.setDate(r.getDate()-7);let a=await c._.user.count({where:{lastLogin:{gte:t}}}),s=await c._.message.count({where:{createdAt:{gte:new Date(new Date().getFullYear(),new Date().getMonth(),1)}}}),n=await c._.payment.aggregate({_sum:{amount:!0},where:{status:"COMPLETED",createdAt:{gte:new Date(new Date().getFullYear(),new Date().getMonth(),1)}}}),o=await m(),l=await g(),w=await d(r);return i.NextResponse.json({activeUsers:a,totalMessages:s,totalRevenue:n._sum.amount||0,systemHealth:o,services:l,dailyStats:w})}catch(e){return console.error("Error fetching system metrics:",e),i.NextResponse.json({error:"Internal server error"},{status:500})}}async function m(){try{return await c._.$queryRaw`SELECT 1`,"healthy"}catch(e){return"critical"}}async function g(){let e=[];try{let t=Date.now();await c._.$queryRaw`SELECT 1`;let r=Date.now()-t;e.push({name:"PostgreSQL",status:"up",responseTime:r})}catch(t){e.push({name:"PostgreSQL",status:"down",responseTime:0})}try{let t=Date.now(),r=await fetch(`${process.env.EVOLUTION_API_URL}/manager/instances`,{headers:{apikey:process.env.EVOLUTION_API_KEY||""}}),a=Date.now()-t;e.push({name:"Evolution API",status:r.ok?"up":"degraded",responseTime:a})}catch(t){e.push({name:"Evolution API",status:"down",responseTime:0})}try{let t=Date.now(),r=Date.now()-t;e.push({name:"Stripe",status:"up",responseTime:r})}catch(t){e.push({name:"Stripe",status:"down",responseTime:0})}return e}async function d(e){let t=[],r=new Date;for(let e=6;e>=0;e--){let a=new Date(r);a.setDate(a.getDate()-e);let s=new Date(a);s.setDate(s.getDate()+1);let[n,o,i]=await Promise.all([c._.user.count({where:{lastLogin:{gte:a,lt:s}}}),c._.message.count({where:{createdAt:{gte:a,lt:s}}}),c._.payment.aggregate({_sum:{amount:!0},where:{status:"COMPLETED",createdAt:{gte:a,lt:s}}})]);t.push({date:a.toLocaleDateString(),users:n,messages:o,revenue:i._sum.amount||0})}return t}let w=new s.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/admin/system-metrics/route",pathname:"/api/admin/system-metrics",filename:"route",bundlePath:"app/api/admin/system-metrics/route"},resolvedPagePath:"/home/ubuntu/comodin_ia/app/app/api/admin/system-metrics/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:h,staticGenerationAsyncStorage:x,serverHooks:D}=w,y="/api/admin/system-metrics/route";function q(){return(0,o.patchFetch)({serverHooks:D,staticGenerationAsyncStorage:x})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[4372,7329,1472,7609,1826],()=>r(89364));module.exports=a})();