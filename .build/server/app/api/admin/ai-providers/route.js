"use strict";(()=>{var e={};e.id=4968,e.ids=[4968],e.modules={53524:e=>{e.exports=require("@prisma/client")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},86624:e=>{e.exports=require("querystring")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},75388:(e,r,t)=>{t.r(r),t.d(r,{originalPathname:()=>g,patchFetch:()=>x,requestAsyncStorage:()=>P,routeModule:()=>f,serverHooks:()=>h,staticGenerationAsyncStorage:()=>v});var a={};t.r(a),t.d(a,{GET:()=>m,POST:()=>y});var i=t(79182),n=t(72007),o=t(56719),s=t(93442),u=t(15649),d=t(11826),p=t(78982),l=t(91209);let c=l.z.object({name:l.z.string().min(1,"Name is required").max(50,"Name too long"),displayName:l.z.string().min(1,"Display name is required").max(100,"Display name too long"),description:l.z.string().optional(),logoUrl:l.z.string().url("Invalid logo URL").optional().or(l.z.literal("")),apiUrl:l.z.string().url("Invalid API URL"),apiKeyName:l.z.string().optional(),apiKey:l.z.string().min(10,"API key too short"),defaultModel:l.z.string().optional(),availableModels:l.z.array(l.z.string()).optional(),inputPricePerToken:l.z.number().positive().optional(),outputPricePerToken:l.z.number().positive().optional(),currency:l.z.string().length(3,"Invalid currency code").optional(),maxTokensPerRequest:l.z.number().positive().optional(),rateLimitPerMinute:l.z.number().positive().optional(),metadata:l.z.record(l.z.any()).optional()});async function m(e){try{let e=await (0,u.getServerSession)(d.L);if(!e?.user)return s.NextResponse.json({error:"Unauthorized"},{status:401});if("SUPER_ADMIN"!==e.user.role)return s.NextResponse.json({error:"Access denied: Super Admin required"},{status:403});let r=await (0,p.s0)(e.user.role);return s.NextResponse.json({success:!0,data:r})}catch(e){return console.error("Error fetching AI providers:",e),s.NextResponse.json({success:!1,error:e instanceof Error?e.message:"Internal server error"},{status:500})}}async function y(e){try{let r=await (0,u.getServerSession)(d.L);if(!r?.user)return s.NextResponse.json({error:"Unauthorized"},{status:401});if("SUPER_ADMIN"!==r.user.role)return s.NextResponse.json({error:"Access denied: Super Admin required"},{status:403});let t=await e.json(),a=c.parse(t),i=await (0,p.GN)(a,r.user.id,r.user.name||r.user.email,r.user.role);return s.NextResponse.json({success:!0,data:i,message:`Provider "${i.displayName}" created successfully`})}catch(e){if(console.error("Error creating AI provider:",e),e instanceof l.z.ZodError)return s.NextResponse.json({success:!1,error:"Validation error",details:e.errors},{status:400});return s.NextResponse.json({success:!1,error:e instanceof Error?e.message:"Internal server error"},{status:500})}}let f=new i.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/admin/ai-providers/route",pathname:"/api/admin/ai-providers",filename:"route",bundlePath:"app/api/admin/ai-providers/route"},resolvedPagePath:"/home/ubuntu/comodin_ia/app/app/api/admin/ai-providers/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:P,staticGenerationAsyncStorage:v,serverHooks:h}=f,g="/api/admin/ai-providers/route";function x(){return(0,o.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:v})}},78982:(e,r,t)=>{t.d(r,{GN:()=>m,f9:()=>v,qI:()=>f,s0:()=>y,hI:()=>w,Dx:()=>x,V6:()=>g,jB:()=>h,yH:()=>P});var a=t(83178),i=t(84770),n=t.n(i);let o="aes-256-gcm";function s(){let e=process.env.ENCRYPTION_SECRET||"default-secret-key-change-in-production";return n().scryptSync(e,"salt",32)}function u(e){try{let r=s(),t=n().randomBytes(16),a=n().createCipher(o,r);a.setAAD(Buffer.from("apikey","utf8"));let i=a.update(e,"utf8","hex");i+=a.final("hex");let u=a.getAuthTag();return t.toString("hex")+u.toString("hex")+i}catch(e){throw console.error("Error encrypting API key:",e),Error("Failed to encrypt API key")}}function d(e){try{let r=s();Buffer.from(e.slice(0,32),"hex");let t=Buffer.from(e.slice(32,64),"hex"),a=e.slice(64),i=n().createDecipher(o,r);i.setAAD(Buffer.from("apikey","utf8")),i.setAuthTag(t);let u=i.update(a,"hex","utf8");return u+=i.final("utf8")}catch(e){throw console.error("Error decrypting API key:",e),Error("Failed to decrypt API key")}}function p(e){if(!e||e.length<8)return"••••••••";let r=e.slice(0,4),t=e.slice(-4),a="•".repeat(Math.min(e.length-8,20));return`${r}${a}${t}`}function l(e,r){if(!e||"string"!=typeof e)return!1;switch(r.toLowerCase()){case"openai":return e.startsWith("sk-")&&e.length>20;case"anthropic":case"claude":return e.startsWith("sk-ant-")||e.startsWith("sk-");case"google":case"gemini":return e.length>=20;case"cohere":return e.length>=40;default:return e.length>=10}}function c(e){if("SUPER_ADMIN"!==e)throw Error("Access denied: Only Super Admin can manage AI providers")}async function m(e,r,t,i){if(c(i),!l(e.apiKey,e.name))throw Error(`Invalid API key format for ${e.name}`);if(await a._.aIProvider.findUnique({where:{name:e.name}}))throw Error(`Provider with name "${e.name}" already exists`);let n=await a._.aIProvider.count(),o=u(e.apiKey);return{...await a._.aIProvider.create({data:{name:e.name,displayName:e.displayName,description:e.description,logoUrl:e.logoUrl,apiUrl:e.apiUrl,apiKeyName:e.apiKeyName||"API_KEY",encryptedApiKey:o,defaultModel:e.defaultModel,availableModels:e.availableModels?JSON.parse(JSON.stringify(e.availableModels)):null,inputPricePerToken:e.inputPricePerToken,outputPricePerToken:e.outputPricePerToken,currency:e.currency||"USD",maxTokensPerRequest:e.maxTokensPerRequest,rateLimitPerMinute:e.rateLimitPerMinute,metadata:e.metadata?JSON.parse(JSON.stringify(e.metadata)):null,isDefault:0===n,createdBy:r,createdByName:t}}),maskedApiKey:p(e.apiKey)}}async function y(e){return c(e),(await a._.aIProvider.findMany({orderBy:[{isDefault:"desc"},{isActive:"desc"},{name:"asc"}]})).map(e=>({...e,maskedApiKey:p(d(e.encryptedApiKey))}))}async function f(e,r){c(r);let t=await a._.aIProvider.findUnique({where:{id:e}});if(!t)throw Error("AI Provider not found");return{...t,maskedApiKey:p(d(t.encryptedApiKey))}}async function P(e,r,t,i,n){c(n);let o=await a._.aIProvider.findUnique({where:{id:e}});if(!o)throw Error("AI Provider not found");if(r.name&&r.name!==o.name&&await a._.aIProvider.findUnique({where:{name:r.name}}))throw Error(`Provider with name "${r.name}" already exists`);let s=o.encryptedApiKey;if(r.apiKey){if(!l(r.apiKey,r.name||o.name))throw Error(`Invalid API key format for ${r.name||o.name}`);s=u(r.apiKey)}let m=await a._.aIProvider.update({where:{id:e},data:{...r.name&&{name:r.name},...r.displayName&&{displayName:r.displayName},...void 0!==r.description&&{description:r.description},...void 0!==r.logoUrl&&{logoUrl:r.logoUrl},...r.apiUrl&&{apiUrl:r.apiUrl},...r.apiKeyName&&{apiKeyName:r.apiKeyName},...r.apiKey&&{encryptedApiKey:s},...void 0!==r.defaultModel&&{defaultModel:r.defaultModel},...r.availableModels&&{availableModels:JSON.parse(JSON.stringify(r.availableModels))},...void 0!==r.inputPricePerToken&&{inputPricePerToken:r.inputPricePerToken},...void 0!==r.outputPricePerToken&&{outputPricePerToken:r.outputPricePerToken},...r.currency&&{currency:r.currency},...void 0!==r.maxTokensPerRequest&&{maxTokensPerRequest:r.maxTokensPerRequest},...void 0!==r.rateLimitPerMinute&&{rateLimitPerMinute:r.rateLimitPerMinute},...r.metadata&&{metadata:JSON.parse(JSON.stringify(r.metadata))},updatedBy:t,updatedByName:i,updatedAt:new Date}});return{...m,maskedApiKey:p(r.apiKey||d(m.encryptedApiKey))}}async function v(e,r){c(r);let t=await a._.aIProvider.findUnique({where:{id:e},include:{_count:{select:{transactions:!0}}}});if(!t)throw Error("AI Provider not found");t._count.transactions>0?await a._.aIProvider.update({where:{id:e},data:{isActive:!1}}):await a._.aIProvider.delete({where:{id:e}})}async function h(e,r,t,i,n){c(n);let o=await a._.aIProvider.update({where:{id:e},data:{isActive:r,updatedBy:t,updatedByName:i,updatedAt:new Date}});return{...o,maskedApiKey:p(d(o.encryptedApiKey))}}async function g(e,r,t,i){c(i),await a._.$transaction(async a=>{await a.aIProvider.updateMany({where:{isDefault:!0},data:{isDefault:!1}}),await a.aIProvider.update({where:{id:e},data:{isDefault:!0,updatedBy:r,updatedByName:t,updatedAt:new Date}})})}async function x(e){let r=await a._.aIProvider.findUnique({where:{id:e,isActive:!0}});if(!r)throw Error("Active AI Provider not found");return d(r.encryptedApiKey)}async function w(){return await a._.aIProvider.findMany({where:{isActive:!0},select:{id:!0,name:!0,displayName:!0,apiUrl:!0,defaultModel:!0,isDefault:!0},orderBy:[{isDefault:"desc"},{name:"asc"}]})}}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),a=r.X(0,[4372,7329,1472,7609,1209,1826],()=>t(75388));module.exports=a})();