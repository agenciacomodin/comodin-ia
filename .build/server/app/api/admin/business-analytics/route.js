"use strict";(()=>{var e={};e.id=1547,e.ids=[1547],e.modules={53524:e=>{e.exports=require("@prisma/client")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},86624:e=>{e.exports=require("querystring")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},14397:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>E,patchFetch:()=>q,requestAsyncStorage:()=>A,routeModule:()=>y,serverHooks:()=>P,staticGenerationAsyncStorage:()=>D});var a={};r.r(a),r.d(a,{GET:()=>m});var n=r(79182),s=r(72007),u=r(56719),o=r(93442),i=r(57978),c=r(11826),l=r(83178);async function m(e){try{let t=await (0,i.getServerSession)(c.L);if(!t||"SUPER_ADMIN"!==t.user.role)return o.NextResponse.json({error:"Unauthorized"},{status:401});let{searchParams:r}=new URL(e.url),a=r.get("timeframe")||"7d",n="7d"===a?7:"30d"===a?30:90,s=new Date;s.setDate(s.getDate()-n);let u=await g(s,n),l=await p(s),m=await w(s,n),x=await d(),_=await h(s);return o.NextResponse.json({growth:u,kpis:l,trends:m,userSegmentation:x,topFeatures:_})}catch(e){return console.error("Error fetching business analytics:",e),o.NextResponse.json({error:"Internal server error"},{status:500})}}async function g(e,t){let r=new Date(e);r.setDate(r.getDate()-t);let[a,n]=await Promise.all([l._.user.count({where:{createdAt:{gte:e}}}),l._.user.count({where:{createdAt:{gte:r,lt:e}}})]),[s,u]=await Promise.all([l._.payment.aggregate({_sum:{amount:!0},where:{status:"COMPLETED",createdAt:{gte:e}}}),l._.payment.aggregate({_sum:{amount:!0},where:{status:"COMPLETED",createdAt:{gte:r,lt:e}}})]),[o,i]=await Promise.all([l._.message.count({where:{createdAt:{gte:e}}}),l._.message.count({where:{createdAt:{gte:r,lt:e}}})]),c=await x(e),m=Number(s._sum.amount||0),g=Number(u._sum.amount||0);return{userGrowth:n?(a-n)/n:0,revenueGrowth:g>0?(m-g)/g:0,messageGrowth:i?(o-i)/i:0,retentionRate:c}}async function p(e){let t=new Date;t.setDate(1),t.setHours(0,0,0,0);let r=await l._.payment.aggregate({_sum:{amount:!0},where:{status:"COMPLETED",createdAt:{gte:t}}}),a=await l._.user.count({where:{lastLogin:{gte:e}}}),n=a>0?Number(r._sum.amount||0)/a:0,s=await _();return{mrr:r._sum.amount||0,arpu:n,churnRate:s,ltv:s>0?n/s:12*n,cac:25}}async function w(e,t){let r=[];for(let a=0;a<t;a++){let t=new Date(e);t.setDate(t.getDate()+a);let n=new Date(t);n.setDate(n.getDate()+1);let[s,u,o,i]=await Promise.all([l._.payment.aggregate({_sum:{amount:!0},where:{status:"COMPLETED",createdAt:{gte:t,lt:n}}}),l._.user.count({where:{createdAt:{gte:t,lt:n}}}),l._.user.count({where:{lastLogin:{gte:t,lt:n}}}),l._.message.count({where:{createdAt:{gte:t,lt:n}}})]);r.push({date:t.toLocaleDateString("es-ES",{month:"short",day:"numeric"}),revenue:s._sum.amount||0,newUsers:u,activeUsers:o,messages:i})}return{daily:r,weekly:[],monthly:[]}}async function d(){let[e,t,r,a]=await Promise.all([l._.organization.count({where:{currentPlan:"STARTER"}}),l._.organization.count({where:{currentPlan:"PREMIUM"}}),l._.organization.count({where:{currentPlan:"ENTERPRISE"}}),l._.organization.count({where:{currentPlan:"FREE"}})]);return[{name:"Free",value:a,arpu:0,retention:.3,engagement:3},{name:"Starter",value:e,arpu:29,retention:.75,engagement:6},{name:"Premium",value:t,arpu:79,retention:.85,engagement:8},{name:"Enterprise",value:r,arpu:199,retention:.95,engagement:9}]}async function h(e){return[{name:"WhatsApp Messaging",usage:95},{name:"AI Responses",usage:78},{name:"Contact Management",usage:68},{name:"Campaign Builder",usage:45},{name:"Analytics Dashboard",usage:32}]}async function x(e){let t=await l._.user.count({where:{createdAt:{lt:e}}}),r=await l._.user.count({where:{createdAt:{lt:e},lastLogin:{gte:e}}});return t>0?r/t:0}async function _(){let e=new Date;e.setMonth(e.getMonth()-1);let t=new Date;t.setMonth(t.getMonth()-2);let r=await l._.user.count({where:{createdAt:{lt:t}}}),a=await l._.user.count({where:{createdAt:{lt:t},lastLogin:{lt:e}}});return r>0?a/r:0}let y=new n.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/admin/business-analytics/route",pathname:"/api/admin/business-analytics",filename:"route",bundlePath:"app/api/admin/business-analytics/route"},resolvedPagePath:"/home/ubuntu/comodin_ia/app/app/api/admin/business-analytics/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:A,staticGenerationAsyncStorage:D,serverHooks:P}=y,E="/api/admin/business-analytics/route";function q(){return(0,u.patchFetch)({serverHooks:P,staticGenerationAsyncStorage:D})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[4372,7329,1472,7609,1826],()=>r(14397));module.exports=a})();