"use strict";(()=>{var e={};e.id=9747,e.ids=[9747],e.modules={21841:e=>{e.exports=require("@aws-sdk/client-s3")},53524:e=>{e.exports=require("@prisma/client")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},86624:e=>{e.exports=require("querystring")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},19147:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>N,patchFetch:()=>q,requestAsyncStorage:()=>y,routeModule:()=>w,serverHooks:()=>C,staticGenerationAsyncStorage:()=>f});var n={};r.r(n),r.d(n,{DELETE:()=>k,GET:()=>m,PUT:()=>g});var o=r(79182),s=r(72007),a=r(56719),i=r(93442),u=r(57978),d=r(11826),c=r(53524),l=r(21841);let p=new c.PrismaClient,x=new l.S3Client({}),h=process.env.AWS_BUCKET_NAME||"";async function m(e,{params:t}){try{let e=await (0,u.getServerSession)(d.L);if(!e?.user)return i.NextResponse.json({error:"No autorizado"},{status:401});let r=e.user.organizationId,n=t.id,o=await p.knowledgeSource.findFirst({where:{id:n,organizationId:r},include:{chunks:{take:10,orderBy:{chunkIndex:"asc"},select:{id:!0,chunkIndex:!0,content:!0,wordCount:!0,status:!0,contentQuality:!0,processingError:!0,createdAt:!0}},_count:{select:{chunks:!0}}}});if(!o)return i.NextResponse.json({error:"Fuente de conocimiento no encontrada"},{status:404});let s={id:o.id,organizationId:o.organizationId,name:o.name,type:o.type,status:o.status,originalFileName:o.originalFileName,sourceUrl:o.sourceUrl,fileSize:o.fileSize,fileMimeType:o.fileMimeType,textContent:o.textContent?.slice(0,1e3),totalChunks:o.totalChunks,processedChunks:o.processedChunks,failedChunks:o.failedChunks,contentQuality:o.contentQuality?.toNumber(),usageCount:o.usageCount,lastUsedAt:o.lastUsedAt,tags:o.tags,metadata:o.metadata,chunkSize:o.chunkSize,chunkOverlap:o.chunkOverlap,lastError:o.lastError,retryCount:o.retryCount,maxRetries:o.maxRetries,createdBy:o.createdBy,createdByName:o.createdByName,createdAt:o.createdAt,updatedAt:o.updatedAt,processedAt:o.processedAt,processingProgress:o.totalChunks>0?Math.round(o.processedChunks/o.totalChunks*100):0,chunks:o.chunks.map(e=>({id:e.id,chunkIndex:e.chunkIndex,content:e.content.slice(0,200)+"...",wordCount:e.wordCount,status:e.status,contentQuality:e.contentQuality?.toNumber(),processingError:e.processingError,createdAt:e.createdAt})),totalChunksCount:o._count.chunks};return i.NextResponse.json({success:!0,data:s})}catch(e){return console.error("Error obteniendo detalles de fuente:",e),i.NextResponse.json({error:"Error interno del servidor"},{status:500})}}async function g(e,{params:t}){try{let r=await (0,u.getServerSession)(d.L);if(!r?.user)return i.NextResponse.json({error:"No autorizado"},{status:401});let n=await e.json(),o=r.user.organizationId,s=t.id;if(!await p.knowledgeSource.findFirst({where:{id:s,organizationId:o}}))return i.NextResponse.json({error:"Fuente de conocimiento no encontrada"},{status:404});let{name:a,tags:c,metadata:l,status:x,chunkSize:h,chunkOverlap:m}=n,g=await p.knowledgeSource.update({where:{id:s},data:{...a&&{name:a},...c&&{tags:c},...l&&{metadata:l},...x&&{status:x},...h&&{chunkSize:h},...m&&{chunkOverlap:m},updatedAt:new Date}});return i.NextResponse.json({success:!0,data:{source:g}})}catch(e){return console.error("Error actualizando fuente:",e),i.NextResponse.json({error:"Error interno del servidor"},{status:500})}}async function k(e,{params:t}){try{let e=await (0,u.getServerSession)(d.L);if(!e?.user)return i.NextResponse.json({error:"No autorizado"},{status:401});let r=e.user.organizationId,n=t.id,o=await p.knowledgeSource.findFirst({where:{id:n,organizationId:r}});if(!o)return i.NextResponse.json({error:"Fuente de conocimiento no encontrada"},{status:404});if(o.fileUrl)try{let e=o.fileUrl.replace(`https://${h}.s3.amazonaws.com/`,""),t=new l.DeleteObjectCommand({Bucket:h,Key:e});await x.send(t)}catch(e){console.error("Error eliminando archivo de S3:",e)}return await p.knowledgeSource.delete({where:{id:n}}),i.NextResponse.json({success:!0,message:"Fuente de conocimiento eliminada correctamente"})}catch(e){return console.error("Error eliminando fuente:",e),i.NextResponse.json({error:"Error interno del servidor"},{status:500})}}let w=new o.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/knowledge/[id]/route",pathname:"/api/knowledge/[id]",filename:"route",bundlePath:"app/api/knowledge/[id]/route"},resolvedPagePath:"/home/ubuntu/comodin_ia/app/app/api/knowledge/[id]/route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:y,staticGenerationAsyncStorage:f,serverHooks:C}=w,N="/api/knowledge/[id]/route";function q(){return(0,a.patchFetch)({serverHooks:C,staticGenerationAsyncStorage:f})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[4372,7329,1472,7609,1826],()=>r(19147));module.exports=n})();