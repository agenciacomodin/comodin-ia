"use strict";(()=>{var e={};e.id=6684,e.ids=[6684,9116],e.modules={21841:e=>{e.exports=require("@aws-sdk/client-s3")},53524:e=>{e.exports=require("@prisma/client")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},86624:e=>{e.exports=require("querystring")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},34381:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>N,patchFetch:()=>S,requestAsyncStorage:()=>f,routeModule:()=>w,serverHooks:()=>I,staticGenerationAsyncStorage:()=>A});var o={};r.r(o),r.d(o,{POST:()=>R});var a=r(79182),n=r(72007),s=r(56719),i=r(93442),p=r(57978),u=r(11826),d=r(53524),l=r(21841),c=r(79116);let m=new d.PrismaClient,x=new l.S3Client({}),E=process.env.AWS_BUCKET_NAME||"",g=process.env.AWS_FOLDER_PREFIX||"";async function R(e){try{let t=await (0,p.getServerSession)(u.L);if(!t?.user)return i.NextResponse.json({error:"No autorizado"},{status:401});let o=t.user.organizationId,a=t.user.id,n=t.user.name||"Usuario",s=await e.formData(),R=s.get("file"),w=s.get("name"),f=JSON.parse(s.get("tags")||"[]"),A=parseInt(s.get("chunkSize")||"1000"),I=parseInt(s.get("chunkOverlap")||"100");if(!R)return i.NextResponse.json({error:"Archivo requerido"},{status:400});if(R.size>c.FQ)return i.NextResponse.json({error:`Archivo demasiado grande. M\xe1ximo ${c.FQ/1024/1024}MB`},{status:400});if(![...c.Eb.pdf,...c.Eb.document,...c.Eb.text,...c.Eb.web].includes(R.type))return i.NextResponse.json({error:"Tipo de archivo no soportado"},{status:400});let N=Date.now(),S=R.name.replace(/[^a-zA-Z0-9.-]/g,"_"),y=`${g}knowledge/${o}/${N}-${S}`,h=Buffer.from(await R.arrayBuffer()),q=new l.PutObjectCommand({Bucket:E,Key:y,Body:h,ContentType:R.type});await x.send(q);let v=`https://${E}.s3.amazonaws.com/${y}`,_=await m.knowledgeSource.create({data:{organizationId:o,name:w||R.name,type:d.KnowledgeSourceType.FILE,status:d.KnowledgeSourceStatus.PROCESSING,originalFileName:R.name,fileUrl:v,fileMimeType:R.type,fileSize:R.size,tags:f,chunkSize:A,chunkOverlap:I,createdBy:a,createdByName:n,metadata:{uploadedAt:new Date().toISOString(),originalSize:R.size,mimeType:R.type}}});return Promise.all([r.e(2770),r.e(6780)]).then(r.bind(r,76780)).then(async({KnowledgeProcessor:e})=>{let t=new e(o,a,n);await t.processKnowledgeSource(_.id)}).catch(e=>{console.error("Error procesando archivo:",e)}),i.NextResponse.json({success:!0,data:{source:{id:_.id,name:_.name,status:_.status,type:_.type,originalFileName:_.originalFileName,fileSize:_.fileSize,createdAt:_.createdAt}}})}catch(e){return console.error("Error subiendo archivo:",e),i.NextResponse.json({error:"Error interno del servidor"},{status:500})}}let w=new a.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/knowledge/upload/route",pathname:"/api/knowledge/upload",filename:"route",bundlePath:"app/api/knowledge/upload/route"},resolvedPagePath:"/home/ubuntu/comodin_ia/app/app/api/knowledge/upload/route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:f,staticGenerationAsyncStorage:A,serverHooks:I}=w,N="/api/knowledge/upload/route";function S(){return(0,s.patchFetch)({serverHooks:I,staticGenerationAsyncStorage:A})}},79116:(e,t,r)=>{var o;r.d(t,{Eb:()=>a,FQ:()=>n,VO:()=>s,Vt:()=>i,qm:()=>p}),r(53524),function(e){e.INSUFFICIENT_BALANCE="INSUFFICIENT_BALANCE",e.NO_PROVIDER_AVAILABLE="NO_PROVIDER_AVAILABLE",e.PROVIDER_ERROR="PROVIDER_ERROR",e.INVALID_REQUEST="INVALID_REQUEST",e.RATE_LIMIT_EXCEEDED="RATE_LIMIT_EXCEEDED",e.INTERNAL_ERROR="INTERNAL_ERROR"}(o||(o={}));let a={pdf:["application/pdf"],document:["application/msword","application/vnd.openxmlformats-officedocument.wordprocessingml.document"],text:["text/plain","text/markdown","text/csv"],web:["text/html"]},n=52428800,s=1e3,i=100,p="text-embedding-3-small"}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),o=t.X(0,[4372,7329,1472,7609,1826],()=>r(34381));module.exports=o})();