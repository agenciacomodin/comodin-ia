"use strict";(()=>{var e={};e.id=9904,e.ids=[9904,9116],e.modules={21841:e=>{e.exports=require("@aws-sdk/client-s3")},53524:e=>{e.exports=require("@prisma/client")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},86624:e=>{e.exports=require("querystring")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},92625:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>h,patchFetch:()=>w,requestAsyncStorage:()=>g,routeModule:()=>x,serverHooks:()=>E,staticGenerationAsyncStorage:()=>R});var s={};r.r(s),r.d(s,{POST:()=>m});var n=r(79182),o=r(72007),a=r(56719),i=r(93442),u=r(57978),l=r(11826),p=r(53524),d=r(76780);let c=new p.PrismaClient;async function m(e){try{let t=await (0,u.getServerSession)(l.L);if(!t?.user)return i.NextResponse.json({error:"No autorizado"},{status:401});let{query:r,maxResults:s=10,minSimilarity:n=.7,sourceTypes:o,sourceTags:a,conversationId:p,userId:m}=await e.json(),x=t.user.organizationId,g=m||t.user.id,R=t.user.name||"Usuario";if(!r||0===r.trim().length)return i.NextResponse.json({error:"Consulta requerida"},{status:400});let E=new d.KnowledgeSearcher(x),h=await E.searchKnowledge(r,{maxResults:s,minSimilarity:n,sourceTypes:o,sourceTags:a});await c.knowledgeUsage.create({data:{organizationId:x,userId:g,userName:R,conversationId:p,query:r,queryType:"similarity",resultsFound:h.totalResults,resultsUsed:h.results.length,avgSimilarity:h.results.length>0?h.results.reduce((e,t)=>e+t.similarity,0)/h.results.length:0,sourcesConsulted:[...new Set(h.results.map(e=>e.sourceId))],chunksRetrieved:h.results.map(e=>e.chunkId),processingTime:h.processingTime,responseGenerated:!1}});let w=[...new Set(h.results.map(e=>e.sourceId))];return w.length>0&&await c.knowledgeSource.updateMany({where:{id:{in:w}},data:{usageCount:{increment:1},lastUsedAt:new Date}}),i.NextResponse.json({success:!0,data:{results:h.results,totalResults:h.totalResults,processingTime:h.processingTime,query:r,filters:{maxResults:s,minSimilarity:n,sourceTypes:o,sourceTags:a}}})}catch(e){return console.error("Error en b\xfasqueda sem\xe1ntica:",e),i.NextResponse.json({error:"Error interno del servidor"},{status:500})}}let x=new n.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/knowledge/search/route",pathname:"/api/knowledge/search",filename:"route",bundlePath:"app/api/knowledge/search/route"},resolvedPagePath:"/home/ubuntu/comodin_ia/app/app/api/knowledge/search/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:g,staticGenerationAsyncStorage:R,serverHooks:E}=x,h="/api/knowledge/search/route";function w(){return(0,a.patchFetch)({serverHooks:E,staticGenerationAsyncStorage:R})}},79116:(e,t,r)=>{var s;r.d(t,{Eb:()=>n,FQ:()=>o,VO:()=>a,Vt:()=>i,qm:()=>u}),r(53524),function(e){e.INSUFFICIENT_BALANCE="INSUFFICIENT_BALANCE",e.NO_PROVIDER_AVAILABLE="NO_PROVIDER_AVAILABLE",e.PROVIDER_ERROR="PROVIDER_ERROR",e.INVALID_REQUEST="INVALID_REQUEST",e.RATE_LIMIT_EXCEEDED="RATE_LIMIT_EXCEEDED",e.INTERNAL_ERROR="INTERNAL_ERROR"}(s||(s={}));let n={pdf:["application/pdf"],document:["application/msword","application/vnd.openxmlformats-officedocument.wordprocessingml.document"],text:["text/plain","text/markdown","text/csv"],web:["text/html"]},o=52428800,a=1e3,i=100,u="text-embedding-3-small"}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[4372,7329,1472,7609,2770,1826,6780],()=>r(92625));module.exports=s})();