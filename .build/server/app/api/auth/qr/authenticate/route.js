"use strict";(()=>{var E={};E.id=5160,E.ids=[5160],E.modules={53524:E=>{E.exports=require("@prisma/client")},20399:E=>{E.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:E=>{E.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:E=>{E.exports=require("buffer")},84770:E=>{E.exports=require("crypto")},76162:E=>{E.exports=require("stream")},21764:E=>{E.exports=require("util")},4455:(E,A,_)=>{_.r(A),_.d(A,{originalPathname:()=>r,patchFetch:()=>V,requestAsyncStorage:()=>W,routeModule:()=>e,serverHooks:()=>t,staticGenerationAsyncStorage:()=>P});var N={};_.r(N),_.d(N,{POST:()=>L});var I=_(79182),S=_(72007),T=_(56719),O=_(93442),C=_(83178),G=_(49165),M=_.n(G),R=_(25590);async function L(E){try{let{token:A,sessionId:N,userEmail:I,userPassword:S}=await E.json();if(!A||!N||!I||!S)return O.NextResponse.json({success:!1,error:"Datos incompletos"},{status:400});let T=await C._.qRSession.findUnique({where:{id:N,token:A}});if(!T)return O.NextResponse.json({success:!1,error:"Sesi\xf3n no v\xe1lida"},{status:404});if(T.expiresAt<new Date)return O.NextResponse.json({success:!1,error:"La sesi\xf3n QR ha expirado"},{status:400});let G=await C._.user.findUnique({where:{email:I},include:{organization:!0}});if(!G)return O.NextResponse.json({success:!1,error:"Usuario no encontrado"},{status:401});if(!G.isActive||"ACTIVE"!==G.organization.status)return O.NextResponse.json({success:!1,error:"Usuario o organizaci\xf3n inactiva"},{status:401});let L=await C._.account.findFirst({where:{userId:G.id,provider:"credentials"}});if(!L?.refresh_token)return O.NextResponse.json({success:!1,error:"M\xe9todo de autenticaci\xf3n no v\xe1lido"},{status:401});let e=_(3390);if(!await e.compare(S,L.refresh_token))return O.NextResponse.json({success:!1,error:"Contrase\xf1a incorrecta"},{status:401});await C._.qRSession.update({where:{id:N},data:{status:"SCANNED",userId:G.id,scannedAt:new Date}});let W=M().sign({userId:G.id,email:G.email,organizationId:G.organizationId,role:G.role,sessionId:N},process.env.NEXTAUTH_SECRET||"fallback-secret",{expiresIn:"1h"});return await C._.qRSession.update({where:{id:N},data:{status:"AUTHENTICATED",authenticatedAt:new Date}}),await C._.user.update({where:{id:G.id},data:{lastLogin:new Date}}),O.NextResponse.json({success:!0,data:{authToken:W,user:{id:G.id,email:G.email,name:G.name,fullName:G.fullName,role:G.role,organizationId:G.organizationId,permissions:(0,R.ai)(G.role).map(E=>E.toString())}}})}catch(E){return console.error("Error en autenticaci\xf3n QR:",E),O.NextResponse.json({success:!1,error:"Error interno del servidor"},{status:500})}}let e=new I.AppRouteRouteModule({definition:{kind:S.x.APP_ROUTE,page:"/api/auth/qr/authenticate/route",pathname:"/api/auth/qr/authenticate",filename:"route",bundlePath:"app/api/auth/qr/authenticate/route"},resolvedPagePath:"/home/ubuntu/comodin_ia/app/app/api/auth/qr/authenticate/route.ts",nextConfigOutput:"",userland:N}),{requestAsyncStorage:W,staticGenerationAsyncStorage:P,serverHooks:t}=e,r="/api/auth/qr/authenticate/route";function V(){return(0,T.patchFetch)({serverHooks:t,staticGenerationAsyncStorage:P})}},83178:(E,A,_)=>{_.d(A,{_:()=>I,db:()=>S});var N=_(53524);let I=globalThis.prisma??new N.PrismaClient,S=I},25590:(E,A,_)=>{var N;function I(E){switch(E){case"SUPER_ADMIN":return["MANAGE_AI_PROVIDERS","VIEW_SYSTEM_ANALYTICS","MANAGE_SYSTEM_SETTINGS","VIEW_ALL_ORGANIZATIONS","SUSPEND_ORGANIZATIONS","PLATFORM_ADMINISTRATION","VIEW_ALL_CONVERSATIONS","MANAGE_CLIENT_ORGANIZATIONS","VIEW_DASHBOARD","VIEW_CRM_INBOX","MANAGE_CRM_CONVERSATIONS","MANAGE_CRM_CONTACTS","VIEW_CRM_ANALYTICS","EXPORT_CRM_DATA","VIEW_CONTACTS","MANAGE_CONTACTS","VIEW_FOLLOW_UPS","CREATE_FOLLOW_UP_SEQUENCES","MANAGE_FOLLOW_UP_SEQUENCES","EXECUTE_FOLLOW_UPS","VIEW_WHATSAPP_CHANNELS","MANAGE_WHATSAPP_CHANNELS","CONNECT_WHATSAPP_QR","CONNECT_WHATSAPP_API","CONFIGURE_WHATSAPP_SETTINGS","VIEW_QUICK_REPLIES","MANAGE_QUICK_REPLIES","MANAGE_GLOBAL_QUICK_REPLIES","VIEW_AUTOMATIONS","MANAGE_AUTOMATIONS","VIEW_AUTOMATION_ANALYTICS","VIEW_KNOWLEDGE_BASE","MANAGE_KNOWLEDGE_BASE","UPLOAD_KNOWLEDGE_SOURCES","MANAGE_KNOWLEDGE_SOURCES","DELETE_KNOWLEDGE_SOURCES","VIEW_INTEGRATIONS","MANAGE_INTEGRATIONS","CONFIGURE_ECOMMERCE","CONNECT_INTEGRATIONS","DISCONNECT_INTEGRATIONS","CONFIGURE_INTEGRATION_SETTINGS","VIEW_CAMPAIGNS","MANAGE_CAMPAIGNS","CREATE_CAMPAIGNS","EXECUTE_CAMPAIGNS","PAUSE_CAMPAIGNS","SEND_BULK_MESSAGES","VIEW_CAMPAIGN_ANALYTICS","USE_AUDIENCE_BUILDER","VIEW_MESSAGE_TEMPLATES","CREATE_MESSAGE_TEMPLATES","MANAGE_MESSAGE_TEMPLATES","SYNC_META_TEMPLATES","DELETE_MESSAGE_TEMPLATES","VIEW_REPORTS","EXPORT_REPORTS","VIEW_ADVANCED_ANALYTICS","VIEW_TEAM_MEMBERS","INVITE_TEAM_MEMBERS","MANAGE_TEAM_ROLES","REMOVE_TEAM_MEMBERS","VIEW_ALL_USERS","INVITE_USERS","MANAGE_USERS","VIEW_BILLING","MANAGE_BILLING","VIEW_USAGE_ANALYTICS","MANAGE_AI_WALLET","MANAGE_WALLET","VIEW_TRANSACTIONS","RECHARGE_WALLET","VIEW_ORGANIZATION_SETTINGS","MANAGE_ORGANIZATION_SETTINGS","EXPORT_ORGANIZATION_DATA","MANAGE_ORGANIZATION","CREATE_CLIENT_ACCOUNTS"];case"PROPIETARIO":return["VIEW_DASHBOARD","VIEW_CRM_INBOX","MANAGE_CRM_CONVERSATIONS","MANAGE_CRM_CONTACTS","VIEW_CRM_ANALYTICS","EXPORT_CRM_DATA","VIEW_CONTACTS","MANAGE_CONTACTS","VIEW_FOLLOW_UPS","CREATE_FOLLOW_UP_SEQUENCES","MANAGE_FOLLOW_UP_SEQUENCES","EXECUTE_FOLLOW_UPS","VIEW_WHATSAPP_CHANNELS","MANAGE_WHATSAPP_CHANNELS","CONNECT_WHATSAPP_QR","CONNECT_WHATSAPP_API","CONFIGURE_WHATSAPP_SETTINGS","VIEW_QUICK_REPLIES","MANAGE_QUICK_REPLIES","MANAGE_GLOBAL_QUICK_REPLIES","VIEW_AUTOMATIONS","MANAGE_AUTOMATIONS","VIEW_AUTOMATION_ANALYTICS","VIEW_KNOWLEDGE_BASE","MANAGE_KNOWLEDGE_BASE","UPLOAD_KNOWLEDGE_SOURCES","MANAGE_KNOWLEDGE_SOURCES","DELETE_KNOWLEDGE_SOURCES","VIEW_INTEGRATIONS","MANAGE_INTEGRATIONS","CONFIGURE_ECOMMERCE","CONNECT_INTEGRATIONS","DISCONNECT_INTEGRATIONS","CONFIGURE_INTEGRATION_SETTINGS","VIEW_CAMPAIGNS","MANAGE_CAMPAIGNS","CREATE_CAMPAIGNS","EXECUTE_CAMPAIGNS","PAUSE_CAMPAIGNS","SEND_BULK_MESSAGES","VIEW_CAMPAIGN_ANALYTICS","USE_AUDIENCE_BUILDER","VIEW_MESSAGE_TEMPLATES","CREATE_MESSAGE_TEMPLATES","MANAGE_MESSAGE_TEMPLATES","SYNC_META_TEMPLATES","DELETE_MESSAGE_TEMPLATES","VIEW_REPORTS","EXPORT_REPORTS","VIEW_ADVANCED_ANALYTICS","VIEW_TEAM_MEMBERS","INVITE_TEAM_MEMBERS","MANAGE_TEAM_ROLES","REMOVE_TEAM_MEMBERS","VIEW_ALL_USERS","INVITE_USERS","MANAGE_USERS","VIEW_BILLING","MANAGE_BILLING","VIEW_USAGE_ANALYTICS","MANAGE_AI_WALLET","MANAGE_WALLET","VIEW_TRANSACTIONS","RECHARGE_WALLET","VIEW_ORGANIZATION_SETTINGS","MANAGE_ORGANIZATION_SETTINGS","EXPORT_ORGANIZATION_DATA","MANAGE_ORGANIZATION","CREATE_CLIENT_ACCOUNTS","DELETE_CAMPAIGNS","VIEW_AUDIENCE_PREVIEW","VIEW_ASSIGNED_CONVERSATIONS","VIEW_ALL_CONVERSATIONS","MANAGE_WHATSAPP_CONFIG","CONFIGURE_AI"];case"DISTRIBUIDOR":return["VIEW_DASHBOARD","VIEW_CRM_INBOX","MANAGE_CRM_CONVERSATIONS","MANAGE_CRM_CONTACTS","VIEW_CRM_ANALYTICS","EXPORT_CRM_DATA","VIEW_CONTACTS","MANAGE_CONTACTS","VIEW_FOLLOW_UPS","CREATE_FOLLOW_UP_SEQUENCES","EXECUTE_FOLLOW_UPS","VIEW_WHATSAPP_CHANNELS","CONNECT_WHATSAPP_QR","CONFIGURE_WHATSAPP_SETTINGS","VIEW_QUICK_REPLIES","MANAGE_QUICK_REPLIES","VIEW_AUTOMATIONS","VIEW_AUTOMATION_ANALYTICS","VIEW_KNOWLEDGE_BASE","UPLOAD_KNOWLEDGE_SOURCES","MANAGE_KNOWLEDGE_SOURCES","VIEW_INTEGRATIONS","CONNECT_INTEGRATIONS","VIEW_CAMPAIGNS","MANAGE_CAMPAIGNS","CREATE_CAMPAIGNS","EXECUTE_CAMPAIGNS","SEND_BULK_MESSAGES","VIEW_CAMPAIGN_ANALYTICS","USE_AUDIENCE_BUILDER","VIEW_MESSAGE_TEMPLATES","CREATE_MESSAGE_TEMPLATES","MANAGE_MESSAGE_TEMPLATES","VIEW_REPORTS","EXPORT_REPORTS","VIEW_TEAM_MEMBERS","VIEW_ALL_USERS","VIEW_BILLING","VIEW_USAGE_ANALYTICS","VIEW_TRANSACTIONS","VIEW_ORGANIZATION_SETTINGS","VIEW_AUDIENCE_PREVIEW","VIEW_ASSIGNED_CONVERSATIONS","MANAGE_CLIENT_ORGANIZATIONS"];default:return["VIEW_DASHBOARD","VIEW_CRM_INBOX","MANAGE_CRM_CONVERSATIONS","VIEW_CRM_ANALYTICS","VIEW_CONTACTS","VIEW_FOLLOW_UPS","EXECUTE_FOLLOW_UPS","VIEW_WHATSAPP_CHANNELS","VIEW_QUICK_REPLIES","MANAGE_QUICK_REPLIES","VIEW_AUTOMATIONS","VIEW_KNOWLEDGE_BASE","VIEW_CAMPAIGNS","VIEW_CAMPAIGN_ANALYTICS","VIEW_MESSAGE_TEMPLATES","VIEW_REPORTS","VIEW_ORGANIZATION_SETTINGS","VIEW_BILLING","VIEW_USAGE_ANALYTICS","VIEW_ASSIGNED_CONVERSATIONS"]}}function S(E,A){return E.includes(A.toString())}function T(E,A){return S(I(E).map(E=>E.toString()),A)}_.d(A,{Fs:()=>S,N$:()=>T,ai:()=>I,y3:()=>N}),function(E){E.VIEW_DASHBOARD="VIEW_DASHBOARD",E.VIEW_CRM_INBOX="VIEW_CRM_INBOX",E.MANAGE_CRM_CONVERSATIONS="MANAGE_CRM_CONVERSATIONS",E.MANAGE_CRM_CONTACTS="MANAGE_CRM_CONTACTS",E.VIEW_CRM_ANALYTICS="VIEW_CRM_ANALYTICS",E.EXPORT_CRM_DATA="EXPORT_CRM_DATA",E.VIEW_CONTACTS="VIEW_CONTACTS",E.MANAGE_CONTACTS="MANAGE_CONTACTS",E.VIEW_FOLLOW_UPS="VIEW_FOLLOW_UPS",E.CREATE_FOLLOW_UP_SEQUENCES="CREATE_FOLLOW_UP_SEQUENCES",E.MANAGE_FOLLOW_UP_SEQUENCES="MANAGE_FOLLOW_UP_SEQUENCES",E.EXECUTE_FOLLOW_UPS="EXECUTE_FOLLOW_UPS",E.VIEW_WHATSAPP_CHANNELS="VIEW_WHATSAPP_CHANNELS",E.MANAGE_WHATSAPP_CHANNELS="MANAGE_WHATSAPP_CHANNELS",E.CONNECT_WHATSAPP_QR="CONNECT_WHATSAPP_QR",E.CONNECT_WHATSAPP_API="CONNECT_WHATSAPP_API",E.CONFIGURE_WHATSAPP_SETTINGS="CONFIGURE_WHATSAPP_SETTINGS",E.VIEW_QUICK_REPLIES="VIEW_QUICK_REPLIES",E.MANAGE_QUICK_REPLIES="MANAGE_QUICK_REPLIES",E.MANAGE_GLOBAL_QUICK_REPLIES="MANAGE_GLOBAL_QUICK_REPLIES",E.VIEW_AUTOMATIONS="VIEW_AUTOMATIONS",E.MANAGE_AUTOMATIONS="MANAGE_AUTOMATIONS",E.VIEW_AUTOMATION_ANALYTICS="VIEW_AUTOMATION_ANALYTICS",E.VIEW_KNOWLEDGE_BASE="VIEW_KNOWLEDGE_BASE",E.MANAGE_KNOWLEDGE_BASE="MANAGE_KNOWLEDGE_BASE",E.UPLOAD_KNOWLEDGE_SOURCES="UPLOAD_KNOWLEDGE_SOURCES",E.MANAGE_KNOWLEDGE_SOURCES="MANAGE_KNOWLEDGE_SOURCES",E.DELETE_KNOWLEDGE_SOURCES="DELETE_KNOWLEDGE_SOURCES",E.VIEW_INTEGRATIONS="VIEW_INTEGRATIONS",E.MANAGE_INTEGRATIONS="MANAGE_INTEGRATIONS",E.CONFIGURE_ECOMMERCE="CONFIGURE_ECOMMERCE",E.CONNECT_INTEGRATIONS="CONNECT_INTEGRATIONS",E.DISCONNECT_INTEGRATIONS="DISCONNECT_INTEGRATIONS",E.CONFIGURE_INTEGRATION_SETTINGS="CONFIGURE_INTEGRATION_SETTINGS",E.VIEW_CAMPAIGNS="VIEW_CAMPAIGNS",E.MANAGE_CAMPAIGNS="MANAGE_CAMPAIGNS",E.CREATE_CAMPAIGNS="CREATE_CAMPAIGNS",E.EXECUTE_CAMPAIGNS="EXECUTE_CAMPAIGNS",E.PAUSE_CAMPAIGNS="PAUSE_CAMPAIGNS",E.SEND_BULK_MESSAGES="SEND_BULK_MESSAGES",E.VIEW_CAMPAIGN_ANALYTICS="VIEW_CAMPAIGN_ANALYTICS",E.USE_AUDIENCE_BUILDER="USE_AUDIENCE_BUILDER",E.VIEW_MESSAGE_TEMPLATES="VIEW_MESSAGE_TEMPLATES",E.CREATE_MESSAGE_TEMPLATES="CREATE_MESSAGE_TEMPLATES",E.MANAGE_MESSAGE_TEMPLATES="MANAGE_MESSAGE_TEMPLATES",E.SYNC_META_TEMPLATES="SYNC_META_TEMPLATES",E.DELETE_MESSAGE_TEMPLATES="DELETE_MESSAGE_TEMPLATES",E.VIEW_REPORTS="VIEW_REPORTS",E.EXPORT_REPORTS="EXPORT_REPORTS",E.VIEW_ADVANCED_ANALYTICS="VIEW_ADVANCED_ANALYTICS",E.VIEW_TEAM_MEMBERS="VIEW_TEAM_MEMBERS",E.INVITE_TEAM_MEMBERS="INVITE_TEAM_MEMBERS",E.MANAGE_TEAM_ROLES="MANAGE_TEAM_ROLES",E.REMOVE_TEAM_MEMBERS="REMOVE_TEAM_MEMBERS",E.VIEW_ALL_USERS="VIEW_ALL_USERS",E.INVITE_USERS="INVITE_USERS",E.MANAGE_USERS="MANAGE_USERS",E.VIEW_BILLING="VIEW_BILLING",E.MANAGE_BILLING="MANAGE_BILLING",E.VIEW_USAGE_ANALYTICS="VIEW_USAGE_ANALYTICS",E.MANAGE_AI_WALLET="MANAGE_AI_WALLET",E.MANAGE_WALLET="MANAGE_WALLET",E.VIEW_TRANSACTIONS="VIEW_TRANSACTIONS",E.RECHARGE_WALLET="RECHARGE_WALLET",E.VIEW_ORGANIZATION_SETTINGS="VIEW_ORGANIZATION_SETTINGS",E.MANAGE_ORGANIZATION_SETTINGS="MANAGE_ORGANIZATION_SETTINGS",E.EXPORT_ORGANIZATION_DATA="EXPORT_ORGANIZATION_DATA",E.MANAGE_ORGANIZATION="MANAGE_ORGANIZATION",E.CREATE_CLIENT_ACCOUNTS="CREATE_CLIENT_ACCOUNTS",E.MANAGE_AI_PROVIDERS="MANAGE_AI_PROVIDERS",E.VIEW_SYSTEM_ANALYTICS="VIEW_SYSTEM_ANALYTICS",E.MANAGE_SYSTEM_SETTINGS="MANAGE_SYSTEM_SETTINGS",E.VIEW_ALL_ORGANIZATIONS="VIEW_ALL_ORGANIZATIONS",E.SUSPEND_ORGANIZATIONS="SUSPEND_ORGANIZATIONS",E.PLATFORM_ADMINISTRATION="PLATFORM_ADMINISTRATION",E.DELETE_CAMPAIGNS="DELETE_CAMPAIGNS",E.VIEW_AUDIENCE_PREVIEW="VIEW_AUDIENCE_PREVIEW",E.VIEW_ASSIGNED_CONVERSATIONS="VIEW_ASSIGNED_CONVERSATIONS",E.VIEW_ALL_CONVERSATIONS="VIEW_ALL_CONVERSATIONS",E.MANAGE_CLIENT_ORGANIZATIONS="MANAGE_CLIENT_ORGANIZATIONS",E.MANAGE_WHATSAPP_CONFIG="MANAGE_WHATSAPP_CONFIG",E.CONFIGURE_AI="CONFIGURE_AI"}(N||(N={}))}};var A=require("../../../../../webpack-runtime.js");A.C(E);var _=E=>A(A.s=E),N=A.X(0,[4372,7329,7609,9165],()=>_(4455));module.exports=N})();